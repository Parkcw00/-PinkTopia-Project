<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì±„íŒ… ë©¤ë²„ ê´€ë¦¬</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .button {
        padding: 8px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .button:hover {
        background-color: #45a049;
      }
      #memberList {
        margin-top: 20px;
      }
      .member-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ì±„íŒ… ë©¤ë²„ ê´€ë¦¬</h1>

      <!-- ì±„íŒ… ë©¤ë²„ ìƒì„± ì„¹ì…˜ -->
      <div class="section">
        <h2>ì±„íŒ… ë©¤ë²„ ìƒì„±</h2>
        <input type="number" id="userId" placeholder="ì‚¬ìš©ì ID" />
        <input type="text" id="chatRoomId" placeholder="ì±„íŒ…ë°© ID" />
        <button class="button" onclick="createChatMember()">ë©¤ë²„ ìƒì„±</button>
      </div>

      <!-- ì±„íŒ… ë©¤ë²„ ëª©ë¡ ì„¹ì…˜ -->
      <div class="section">
        <h2>ì±„íŒ… ë©¤ë²„ ëª©ë¡</h2>
        <button class="button" onclick="getAllChatMembers()">
          ë©¤ë²„ ëª©ë¡ ì¡°íšŒ
        </button>
        <div id="memberList"></div>
      </div>

      <!-- ì±„íŒ… ë©¤ë²„ ìƒì„¸ ì¡°íšŒ ì„¹ì…˜ -->
      <div class="section">
        <h2>ì±„íŒ… ë©¤ë²„ ìƒì„¸ ì¡°íšŒ</h2>
        <input type="number" id="searchMemberId" placeholder="ë©¤ë²„ ID" />
        <button class="button" onclick="findOneChatMember()">ë©¤ë²„ ì¡°íšŒ</button>
        <div id="memberDetails"></div>
      </div>

      <!-- ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì„¹ì…˜ -->
      <div class="section">
        <h2>ì±„íŒ…ë°© ë‚˜ê°€ê¸°</h2>
        <input type="number" id="deleteMemberId" placeholder="ë©¤ë²„ ID" />
        <button class="button" onclick="deleteChatMember()">
          ì±„íŒ…ë°© ë‚˜ê°€ê¸°
        </button>
      </div>
    </div>

    <script>
      const socket = io('http://localhost:3000/chatmember', {
        withCredentials: true,
        transports: ['websocket', 'polling'],
        extraHeaders: {
          'Access-Control-Allow-Origin': 'http://127.0.0.1:5500',
        },
      });

      // ì†Œì¼“ ì—°ê²°/í•´ì œ ì´ë²¤íŠ¸
      socket.on('connect', () => {
        console.log('ğŸŸ¢ ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ì†Œì¼“ ID:', socket.id);
      });

      socket.on('disconnect', () => {
        console.log('ğŸ”´ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
      });

      // ì±„íŒ… ë©¤ë²„ ìƒì„±
      function createChatMember() {
        const userId = document.getElementById('userId').value;
        const chatRoomId = document.getElementById('chatRoomId').value;

        const createChatmemberDto = {
          chatting_room_id: parseInt(chatRoomId),
          admin: false, // ê¸°ë³¸ê°’ìœ¼ë¡œ false ì„¤ì •
        };

        console.log('ğŸ“¤ ì±„íŒ… ë©¤ë²„ ìƒì„± ìš”ì²­:', {
          userId: parseInt(userId),
          createChatmemberDto: createChatmemberDto,
        });

        socket.emit('createChatmember', {
          userId: parseInt(userId),
          createChatmemberDto: createChatmemberDto,
        });
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      socket.on('chatmemberCreated', (chatmember) => {
        console.log('ğŸ“¥ ìƒˆë¡œìš´ ì±„íŒ… ë©¤ë²„ê°€ ìƒì„±ë¨:', chatmember);
        alert(`ì±„íŒ… ë©¤ë²„ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\në©¤ë²„ ID: ${chatmember.id}`);
      });

      // ì „ì²´ ë©¤ë²„ ì¡°íšŒ
      function getAllChatMembers() {
        console.log('ğŸ“¤ ì „ì²´ ë©¤ë²„ ëª©ë¡ ì¡°íšŒ ìš”ì²­');
        socket.emit('findAllChatMember');
      }

      // ì „ì²´ ë©¤ë²„ ì¡°íšŒ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆ
      socket.on('allChatMembers', (chatmembers) => {
        console.log('ğŸ“¥ ì „ì²´ ë©¤ë²„ ëª©ë¡ ìˆ˜ì‹ :', chatmembers);
        const memberList = document.getElementById('memberList');
        memberList.innerHTML = '';
        chatmembers.forEach((member) => {
          memberList.innerHTML += `
            <div class="member-item">
              ë©¤ë²„ ID: ${member.id},
              ì‚¬ìš©ì ID: ${member.user_id},
              ì±„íŒ…ë°© ID: ${member.chatting_room_id}
            </div>`;
        });
      });

      // íŠ¹ì • ë©¤ë²„ ì¡°íšŒ
      function findOneChatMember() {
        const chatmemberId = document.getElementById('searchMemberId').value;
        console.log('ğŸ“¤ íŠ¹ì • ë©¤ë²„ ì¡°íšŒ ìš”ì²­:', {
          chatmemberId: parseInt(chatmemberId),
        });
        socket.emit('findOneChatMember', {
          chatmemberId: parseInt(chatmemberId),
        });
      }

      // ìƒì„¸ ì¡°íšŒ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆ
      socket.on('chatmemberDetails', (chatmember) => {
        console.log('ğŸ“¥ ë©¤ë²„ ìƒì„¸ ì •ë³´ ìˆ˜ì‹ :', chatmember);
        const memberDetails = document.getElementById('memberDetails');
        memberDetails.innerHTML = `
          <div class="member-item">
            <h3>ë©¤ë²„ ìƒì„¸ ì •ë³´</h3>
            <p>ë©¤ë²„ ID: ${chatmember.id}</p>
            <p>ì‚¬ìš©ì ID: ${chatmember.user_id}</p>
            <p>ì±„íŒ…ë°© ID: ${chatmember.chatting_room_id}</p>
            <p>ê´€ë¦¬ì ì—¬ë¶€: ${chatmember.admin ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}</p>
            <h4>ì‚¬ìš©ì ì •ë³´</h4>
            <p>ë‹‰ë„¤ì„: ${chatmember.user.nickname}</p>
            <p>ì´ë©”ì¼: ${chatmember.user.email}</p>
            <p>í”„ë¡œí•„ ì´ë¯¸ì§€: ${chatmember.user.profile_image}</p>
            <p>ìƒë…„ì›”ì¼: ${chatmember.user.birthday}</p>
          </div>`;
      });

      // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
      function deleteChatMember() {
        const chatmemberId = document.getElementById('deleteMemberId').value;
        console.log('ğŸ“¤ ì±„íŒ…ë°© ë‚˜ê°€ê¸° ìš”ì²­:', {
          chatmemberId: parseInt(chatmemberId),
        });
        socket.emit('deleteChatMember', {
          chatmemberId: parseInt(chatmemberId),
        });
      }

      // ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì™„ë£Œ ë¦¬ìŠ¤ë„ˆ
      socket.on('chatmemberDeleted', (data) => {
        console.log('ğŸ“¥ ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì™„ë£Œ:', data);
        alert(`ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤. (ë©¤ë²„ ID: ${data.chatmemberId})`);
      });

      // ì—ëŸ¬ ì²˜ë¦¬
      socket.on('error', (error) => {
        console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
      });
    </script>
  </body>
</html>
