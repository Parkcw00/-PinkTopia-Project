<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì±„íŒ…ë°© ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .button {
        padding: 8px 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .button:hover {
        background-color: #c82333;
      }
      #blacklistList {
        margin-top: 20px;
      }
      .blacklist-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <div class="nav" style="display: flex; justify-content: space-between; background-color: #ff69b4; padding: 15px; color: white; font-weight: bold;">
        <div>
            <a href="/public/home.html" style="text-decoration: none; color: white;">PinkTophia</a>
        </div>
        <div>
            <a href="/public/home.html" style="color: white; text-decoration: none; margin: 0 10px;">í™ˆìœ¼ë¡œ</a>
        </div>
    </div>
    <div class="container">
      <h1>ì±„íŒ…ë°© ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</h1>

      <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ì„¹ì…˜ -->
      <div class="section">
        <h2>ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</h2>
        <input type="number" id="userId" placeholder="ì°¨ë‹¨í•  ì‚¬ìš©ì ID" />
        <input type="number" id="chatRoomId" placeholder="ì±„íŒ…ë°© ID" />
        <button class="button" onclick="createBlacklist()">ì°¨ë‹¨í•˜ê¸°</button>
      </div>

      <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ì„¹ì…˜ -->
      <div class="section">
        <h2>ë¸”ë™ë¦¬ìŠ¤íŠ¸ ëª©ë¡</h2>
        <button class="button" onclick="getAllBlacklists()">ëª©ë¡ ì¡°íšŒ</button>
        <div id="blacklistList"></div>
      </div>

      <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì„¹ì…˜ -->
      <div class="section">
        <h2>ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ</h2>
        <input
          type="number"
          id="searchBlacklistId"
          placeholder="ë¸”ë™ë¦¬ìŠ¤íŠ¸ ID"
        />
        <button class="button" onclick="findOneBlacklist()">ìƒì„¸ ì¡°íšŒ</button>
        <div id="blacklistDetails"></div>
      </div>

      <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì„¹ì…˜ -->
      <div class="section">
        <h2>ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ</h2>
        <input
          type="number"
          id="removeBlacklistId"
          placeholder="ë¸”ë™ë¦¬ìŠ¤íŠ¸ ID"
        />
        <button class="button" onclick="removeBlacklist()">ì°¨ë‹¨ í•´ì œ</button>
      </div>
    </div>

    <script>
      const socket = io('/chatblacklist', {
        withCredentials: true,
        transports: ['websocket', 'polling'],
        extraHeaders: {
          'Access-Control-Allow-Origin': 'http://127.0.0.1:5500',
        },
      });

      // ì†Œì¼“ ì—°ê²°/í•´ì œ ì´ë²¤íŠ¸
      socket.on('connect', () => {
        console.log('ğŸŸ¢ ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ì†Œì¼“ ID:', socket.id);
      });

      socket.on('disconnect', () => {
        console.log('ğŸ”´ ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
      });

      // ì±„íŒ…ë©¤ë²„ ê´€ë ¨ ì†Œì¼“ ì—°ê²°
      const chatmemberSocket = io('/chatmember', {
        withCredentials: true,
        transports: ['websocket', 'polling'],
        extraHeaders: {
          'Access-Control-Allow-Origin': 'http://127.0.0.1:5500',
        },
      });

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
      function createBlacklist() {
        const userId = document.getElementById('userId').value;
        const chatRoomId = document.getElementById('chatRoomId').value;

        const createChatblacklistDto = {
          user_id: parseInt(userId),
          chatting_room_id: parseInt(chatRoomId),
        };

        console.log('ğŸ“¤ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ìš”ì²­:', {
          userId: parseInt(userId),
          createChatblacklistDto,
        });

        socket.emit('createBlacklist', {
          userId: parseInt(userId),
          createChatblacklistDto,
        });
      }

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ ë¦¬ìŠ¤ë„ˆ
      socket.on('blacklistCreated', async (blacklist) => {
        console.log('ğŸ“¥ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ë¨:', blacklist);
        alert(`ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸”ë™ë¦¬ìŠ¤íŠ¸ ID: ${blacklist.id}`);

        // ì±„íŒ…ë©¤ë²„ ëª©ë¡ ì¡°íšŒí•˜ì—¬ ê°•ì œ í‡´ì¥ ì²˜ë¦¬
        chatmemberSocket.emit('findAllChatMember');
      });

      // ì „ì²´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
      function getAllBlacklists() {
        console.log('ğŸ“¤ ì „ì²´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ìš”ì²­');
        socket.emit('findAllBlacklist');
      }

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
      socket.on('allBlacklists', (blacklists) => {
        console.log('ğŸ“¥ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ìˆ˜ì‹ :', blacklists);
        const blacklistList = document.getElementById('blacklistList');
        blacklistList.innerHTML = '';
        blacklists.forEach((blacklist) => {
          blacklistList.innerHTML += `
                    <div class="blacklist-item">
                        ë¸”ë™ë¦¬ìŠ¤íŠ¸ ID: ${blacklist.id},
                        ì°¨ë‹¨ëœ ì‚¬ìš©ì ID: ${blacklist.user_id},
                        ì±„íŒ…ë°© ID: ${blacklist.chatting_room_id}
                    </div>`;
        });
      });

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ
      function findOneBlacklist() {
        const blacklistId = document.getElementById('searchBlacklistId').value;
        console.log('ğŸ“¤ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ìš”ì²­:', {
          blacklistId: parseInt(blacklistId),
        });
        socket.emit('findOneBlacklist', {
          blacklistId: parseInt(blacklistId),
        });
      }

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
      socket.on('blacklistDetails', (blacklist) => {
        console.log('ğŸ“¥ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ ìˆ˜ì‹ :', blacklist);
        const blacklistDetails = document.getElementById('blacklistDetails');
        blacklistDetails.innerHTML = `
                <div class="blacklist-item">
                    <h3>ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìƒì„¸ ì •ë³´</h3>
                    <p>ë¸”ë™ë¦¬ìŠ¤íŠ¸ ID: ${blacklist.id}</p>
                    <p>ì°¨ë‹¨ëœ ì‚¬ìš©ì ID: ${blacklist.user_id}</p>
                    <p>ì±„íŒ…ë°© ID: ${blacklist.chatting_room_id}</p>
                    <p>ìƒì„±ì¼: ${blacklist.created_at}</p>
                </div>`;
      });

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ
      function removeBlacklist() {
        const blacklistId = document.getElementById('removeBlacklistId').value;
        console.log('ğŸ“¤ ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ ìš”ì²­:', {
          blacklistId: parseInt(blacklistId),
        });
        socket.emit('removeBlacklist', {
          blacklistId: parseInt(blacklistId),
        });
      }

      // ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì™„ë£Œ ë¦¬ìŠ¤ë„ˆ
      socket.on('blacklistRemoved', (data) => {
        console.log('ğŸ“¥ ë¸”ë™ë¦¬ìŠ¤íŠ¸ í•´ì œ ì™„ë£Œ:', data);
        alert(`ë¸”ë™ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ${data.blacklistId})`);
      });

      // ì±„íŒ…ë©¤ë²„ ëª©ë¡ ìˆ˜ì‹  ë° ì²˜ë¦¬
      chatmemberSocket.on('allChatMembers', (chatmembers) => {
        console.log('ğŸ“¥ ì±„íŒ…ë©¤ë²„ ëª©ë¡ ìˆ˜ì‹ :', chatmembers);
        const blacklistedUserId = document.getElementById('userId').value;
        const blacklistedRoomId = document.getElementById('chatRoomId').value;

        // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ëœ ì‚¬ìš©ìì˜ ì±„íŒ…ë©¤ë²„ ì°¾ê¸°
        const targetMember = chatmembers.find(
          (member) =>
            member.user_id === parseInt(blacklistedUserId) &&
            member.chatting_room_id === parseInt(blacklistedRoomId),
        );

        if (targetMember) {
          console.log('ğŸš« ì°¨ë‹¨ëœ ì‚¬ìš©ìì˜ ì±„íŒ…ë©¤ë²„ ë°œê²¬:', targetMember);
          // ì±„íŒ…ë°©ì—ì„œ ê°•ì œ í‡´ì¥
          chatmemberSocket.emit('deleteChatMember', {
            chatmemberId: targetMember.id,
          });
        }
      });

      // ì—ëŸ¬ ì²˜ë¦¬
      socket.on('error', (error) => {
        console.error('âŒ ì˜¤ë¥˜ ë°œìƒ:', error);
        let errorMessage = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ';

        switch (error.message) {
          case 'BLACKLIST_ALREADY_EXISTS':
            errorMessage += 'ì´ë¯¸ ì°¨ë‹¨ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.';
            break;
          case 'USER_NOT_FOUND':
            errorMessage += 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.';
            break;
          case 'CHATROOM_NOT_FOUND':
            errorMessage += 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±„íŒ…ë°©ì…ë‹ˆë‹¤.';
            break;
          case 'BLACKLIST_NOT_FOUND':
            errorMessage += 'ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            break;
          default:
            errorMessage += error.message;
        }

        alert(errorMessage);
      });
    </script>
  </body>
</html>
