<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—…ì  | PinkTopia</title>
    <link rel="stylesheet" href="/public/styles.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffe4f7;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ff69b4;
            padding: 15px;
            color: white;
            font-weight: bold;
            height: 50px;
            position: relative;
        }

        .menu-icon {
            position: absolute;
            left: 15px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            z-index: 2;
        }

        .menu-icon .hamburger {
            width: 25px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .menu-icon .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background-color: white;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .nav .logo-container {
            position: absolute;
            left: 50px;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .nav img {
            width: 45px;
            height: 45px;
            border-radius: 0;
            object-fit: cover;
        }

        .nav .logo-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }

        .user-assets {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 8px 15px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(255, 98, 182, 0.3);
        }

        .asset-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #9c195f;
            font-weight: bold;
        }

        .asset-item img {
            width: 20px;
            height: 20px;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #ff69b4;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar a:hover {
            background-color: #ff4da6;
        }

        .sidebar a.active {
            background-color: #ff4da6;
            font-weight: bold;
        }

        .close-sidebar {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
            color: white;
        }

        /* ì—…ì  ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            background-color: #ffb6c1;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #ff69b4;
            color: white;
        }

        .achievement-list {
            display: none;
        }

        .achievement-list.active {
            display: block;
        }

        .achievement-item {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .achievement-header {
            padding: 15px;
            background-color: #ffb6c1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .achievement-title-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .achievement-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .achievement-progress-percent {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ff4081;
        }

        .achievement-category {
            background-color: #ff69b4;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .achievement-content {
            padding: 15px;
            display: none;
        }

        .achievement-content.active {
            display: block;
        }

        .achievement-description {
            margin-bottom: 15px;
            color: #555;
        }

        .reward-info {
            display: flex;
            margin-bottom: 15px;
        }

        .reward-item {
            background-color: #f8f8f8;
            border-radius: 5px;
            padding: 8px 12px;
            margin-right: 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .reward-item img {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }

        .sub-achievements {
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .sub-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            transition: all 0.2s ease;
        }

        .sub-item:hover {
            background-color: #f0f0f0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .sub-item-check {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: transparent;
            background-color: white;
        }

        .sub-item.completed .sub-item-check {
            background-color: #ff69b4;
            border-color: #ff69b4;
            color: white;
        }

        .sub-item-content {
            flex-grow: 1;
        }

        .sub-item-text {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sub-item-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .sub-item-workflow {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }

        .sub-item-workflow.completed {
            color: #4caf50;
        }
        
        .sub-achievements h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #ff69b4;
            font-size: 1rem;
        }

        .expiry-date {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
            text-align: right;
        }

        .achievement-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .progress-bar {
            flex-grow: 1;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin: 0 10px;
            overflow: hidden;
        }

        .progress-filled {
            height: 100%;
            background-color: #ff69b4;
            width: 0%;
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state img {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .progress-count {
            font-size: 0.9rem;
            color: #666;
            margin-right: 5px;
        }

        .completed-achievement {
            background-color: #f0f0f0;
        }

        .completed-badge {
            background-color: #ff69b4;
            color: white;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 5px;
        }

        /* ì›Œí¬í”Œë¡œìš° ì„¤ëª… ê´€ë ¨ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .workflow-explanation {
            background-color: #f8e5ff;
            border-left: 3px solid #ff69b4;
            padding: 10px 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #333;
            border-radius: 0 5px 5px 0;
        }

        .workflow-explanation.completed {
            background-color: #e5ffe8;
            border-left-color: #4caf50;
        }
    </style>
</head>

<body>
    <div class="nav">
        <div class="menu-icon" onclick="openSidebar()">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="logo-container">
            <img src="/public/images/123.jpg" alt="PinkTopia Logo">
        </div>
        <div class="logo-text">
            <a href="/public/home.html" style="text-decoration: none; color: white;">PinkTopia</a>
        </div>
        <div id="userAssets" class="user-assets" style="display: none;">
            <div class="asset-item">
                <img src="/public/images/gem.png" alt="ì ¬">
                <span id="userGem">ë¡œë”© ì¤‘...</span> ì ¬
            </div>
            <div class="asset-item">
                <img src="/public/images/dia.png" alt="ë‹¤ì´ì•„">
                <span id="userDia">ë¡œë”© ì¤‘...</span> ë‹¤ì´ì•„
            </div>
        </div>
    </div>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="close-sidebar" onclick="closeSidebar()">&times;</span>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <a href="/public/home.html">í™ˆ</a>
            <a href="/public/event.html">ì´ë²¤íŠ¸</a>
            <a href="/public/store-item.html">ì•„ì´í…œìƒµ</a>
            <a href="/public/board.html">ê²Œì‹œê¸€ (ì»¤ë®¤ë‹ˆí‹°)</a>
            <a href="/public/ranking.html">ë­í‚¹</a>
            <!-- ë¡œê·¸ì¸ ì‹œ í‘œì‹œë  ë©”ë‰´ë“¤ -->
            <div id="loggedInMenu" style="display: none;">
                <a href="/public/chattingrooms.html">ì±„íŒ…</a>
                <a href="/public/collection.html">í•‘í¬ëª½ ê°œì¸ ë„ê°</a>
                <a href="/public/inventory.html">ì¸ë²¤í† ë¦¬ ì•„ì´í…œ</a>
                <a href="/public/achievements.html" class="active">ì—…ì </a>
                <a href="/public/mypage.html">ë§ˆì´í˜ì´ì§€</a>
                <a href="/public/customer-service.html">ê³ ê°ì„¼í„°</a>
                <a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <!-- ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° í‘œì‹œë  ë©”ë‰´ë“¤ -->
            <div id="loggedOutMenu">
                <a href="/public/log-in.html">ë¡œê·¸ì¸</a>
                <a href="/public/sign-up.html">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>

    <!-- ì—…ì  ì»¨í…ì¸  ì¶”ê°€ -->
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="all">ì „ì²´ ì—…ì </div>
            <div class="tab" data-tab="active">ì§„í–‰ì¤‘ì¸ ì—…ì </div>
            <div class="tab" data-tab="completed">ì™„ë£Œëœ ì—…ì </div>
        </div>

        <!-- ì „ì²´ ì—…ì  ëª©ë¡ -->
        <div class="achievement-list active" id="all-achievements">
            <!-- ì—…ì  í•­ëª©ì€ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
        </div>

        <!-- ì§„í–‰ì¤‘ì¸ ì—…ì  ëª©ë¡ -->
        <div class="achievement-list" id="active-achievements">
            <div class="info-message" style="background-color: #fff6f6; border-left: 3px solid #ff69b4; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                <p style="margin: 0; color: #333;">ì§„í–‰ ì¤‘ì¸ ì—…ì ì€ <strong>ìµœì†Œ 1ê°œ ì´ìƒì˜ ì„œë¸Œì—…ì ì´ ì™„ë£Œëœ</strong> ì—…ì ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
            <!-- ì—…ì  í•­ëª©ì€ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
        </div>

        <!-- ì™„ë£Œëœ ì—…ì  ëª©ë¡ -->
        <div class="achievement-list" id="completed-achievements">
            <!-- ì—…ì  í•­ëª©ì€ JavaScriptë¡œ ë™ì  ìƒì„±ë¨ -->
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ë©”ë‰´ ì„¤ì •
            const accessToken = localStorage.getItem("accessToken");
            
            if (accessToken) {
                document.getElementById("userAssets").style.display = "flex";
                document.getElementById('loggedInMenu').style.display = 'block';
                document.getElementById('loggedOutMenu').style.display = 'none';
                
                // ì‚¬ìš©ì ì •ë³´ ë° ìì‚° ë¡œë“œ
                await loadUserData();
                
                // ì—…ì  ë°ì´í„° ë¡œë“œ
                fetchAchievements();
            } else {
                document.getElementById('loggedInMenu').style.display = 'none';
                document.getElementById('loggedOutMenu').style.display = 'block';
                
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ì—…ì  í˜ì´ì§€ì— ì ‘ê·¼ ë¶ˆê°€)
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
                window.location.href = "/public/log-in.html";
            }
        });
        
        // ì‚¬ìš©ì ì •ë³´ ë° ìì‚° ë¡œë“œ í•¨ìˆ˜ (chattingrooms.html ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
        async function loadUserData() {
            try {
                const accessToken = localStorage.getItem("accessToken");
                if (!accessToken) {
                    throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                }
                
                const response = await fetch("/user/me", {
                    headers: { "Authorization": accessToken }
                });
                
                if (!response.ok) {
                    throw new Error("ìœ ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                
                const userData = await response.json();
                console.log("ì‚¬ìš©ì ë°ì´í„°:", userData);
                
                // ìì‚° ì •ë³´ í‘œì‹œ
                document.getElementById("userGem").textContent = userData.pink_gem.toLocaleString();
                document.getElementById("userDia").textContent = userData.pink_dia.toLocaleString();
                
                // ìœ ì € ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (í•„ìš”í•œ ê²½ìš° ì‚¬ìš©)
                window.currentUser = {
                    id: userData.id,
                    nickname: userData.nickname,
                    email: userData.email,
                    level: userData.level || 1,
                    pink_gem: userData.pink_gem,
                    pink_dia: userData.pink_dia
                };
                
                // ì‚¬ì´ë“œë°”ì— ì‚¬ìš©ì ë‹‰ë„¤ì„ í‘œì‹œ (ì„ íƒì )
                if (userData.nickname) {
                    // ì‚¬ì´ë“œë°” ìµœìƒë‹¨ì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
                    const userInfoHTML = `
                        <div style="padding: 15px 25px; color: white; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                            <p style="margin: 0; font-weight: bold;">${userData.nickname}</p>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">ë ˆë²¨ ${userData.level || 1}</p>
                        </div>
                    `;
                    
                    // ì‚¬ì´ë“œë°” ì²« ë²ˆì§¸ í•­ëª© ì•ì— ì‚½ì…
                    const sidebarContent = document.getElementById('sidebarContent');
                    sidebarContent.innerHTML = userInfoHTML + sidebarContent.innerHTML;
                }
                
            } catch (error) {
                console.error("ìœ ì € ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                if (error.message.includes("ì¸ì¦") || error.message.includes("expired")) {
                    alert("ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    logout();
                }
            }
        }
        
        function openSidebar() {
            document.getElementById('sidebar').style.width = "250px";
        }

        function closeSidebar() {
            document.getElementById('sidebar').style.width = "0";
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (chattingrooms.html ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
        async function logout() {
            try {
                const accessToken = localStorage.getItem("accessToken");
                if (!accessToken) {
                    console.warn("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹œë„: ì´ë¯¸ ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœ");
                    window.location.href = "/public/log-in.html";
                    return;
                }

                // ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ë³´ë‚´ê¸°
                const response = await fetch("http://localhost:3000/user/auth/logout", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": accessToken
                    },
                    credentials: "include" // ì¿ í‚¤ë„ í•¨ê»˜ ë³´ë‚´ê¸°
                });

                if (!response.ok) {
                    throw new Error("ì„œë²„ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨");
                }

                // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„, í† í° ì‚­ì œ
                localStorage.removeItem("accessToken");

                console.log("âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ! í˜ì´ì§€ ì´ë™");
                window.location.href = "/public/home.html";
            } catch (error) {
                console.error("âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
                alert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ í† í° ì‚­ì œ ë° í™ˆìœ¼ë¡œ ì´ë™
                localStorage.removeItem("accessToken");
                window.location.href = "/public/home.html";
            }
        }

        // íƒ­ ì „í™˜ ê¸°ëŠ¥
        const tabs = document.querySelectorAll('.tab');
        const achievementLists = document.querySelectorAll('.achievement-list');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // ëª¨ë“  íƒ­ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                tabs.forEach(t => t.classList.remove('active'));
                
                // í´ë¦­ëœ íƒ­ì— active í´ë˜ìŠ¤ ì¶”ê°€
                tab.classList.add('active');
                
                // ëª¨ë“  ì—…ì  ëª©ë¡ ìˆ¨ê¸°ê¸°
                achievementLists.forEach(list => list.classList.remove('active'));
                
                // ì„ íƒëœ íƒ­ì— í•´ë‹¹í•˜ëŠ” ì—…ì  ëª©ë¡ í‘œì‹œ
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-achievements`).classList.add('active');
            });
        });

        // ì—…ì  í† ê¸€ ê¸°ëŠ¥
        function toggleAchievement(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        }

        // ê° ì—…ì ì— ëŒ€í•œ ì„œë¸Œì—…ì  ê°€ì ¸ì˜¤ê¸°
        async function fetchSubAchievements(achievement) {
            if (!achievement || !achievement.id) return achievement;
            
            try {
                const accessToken = localStorage.getItem("accessToken");
                const headers = accessToken ? { "Authorization": accessToken } : {};
                
                console.log(`ì—…ì  ID ${achievement.id}(${achievement.title || 'ì œëª© ì—†ìŒ'})ì˜ ì„œë¸Œì—…ì  ë°ì´í„° ìš”ì²­...`);
                
                // ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš© (ì™„ë£Œ ìƒíƒœ í¬í•¨)
                let response = await fetch(`/achievement/achievementId/${achievement.id}/withStatus`, { headers });
                
                // ìƒˆ ì—”ë“œí¬ì¸íŠ¸ê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‹¤íŒ¨í•˜ë©´ ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                if (!response.ok) {
                    console.log(`ìƒˆ ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨, ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„...`);
                    // ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„
                    response = await fetch(`/achievement/achievementId/${achievement.id}`, { headers });
                    
                    // ë§Œì•½ 404ë¼ë©´ ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„
                    if (!response.ok && response.status === 404) {
                        console.log(`ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì„œë¸Œì—…ì  ëª»ì°¾ìŒ, ë‘ ë²ˆì§¸ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„...`);
                        // ë‘ ë²ˆì§¸ ì—”ë“œí¬ì¸íŠ¸ ì‹œë„ (/achievement/:id)
                        response = await fetch(`/achievement/${achievement.id}`, { headers });
                    }
                }
                
                // ì—¬ì „íˆ ì‹¤íŒ¨í•˜ë©´ ì„œë¸Œì—…ì  ì—†ì´ ë°˜í™˜
                if (!response.ok) {
                    console.error(`ì—…ì  ID ${achievement.id}ì˜ ì„œë¸Œì—…ì  ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                    return achievement;
                }
                
                const data = await response.json();
                console.log(`ì—…ì  ID ${achievement.id}(${achievement.title || 'ì œëª© ì—†ìŒ'})ì˜ ì„œë¸Œì—…ì  ë°ì´í„°:`, data);
                
                // API ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ ì„œë¸Œì—…ì  ë°ì´í„° ì¶”ì¶œ
                if (data && data.subAchievements) {
                    achievement.sub_achievement = data.subAchievements;
                } else if (data && Array.isArray(data)) {
                    // ë°°ì—´ í˜•íƒœë¡œ ë°˜í™˜ë  ê²½ìš°
                    achievement.sub_achievement = data;
                } else if (data && typeof data === 'object') {
                    // ë‹¤ë¥¸ êµ¬ì¡°ì¼ ê²½ìš° í™•ì¸
                    if (Array.isArray(data.sub_achievement)) {
                        achievement.sub_achievement = data.sub_achievement;
                    } else if (data.id === achievement.id && Array.isArray(data.subAchievement)) {
                        // ë‹¨ì¼ ê°ì²´ë¡œ ë°˜í™˜ë˜ëŠ” ê²½ìš°
                        achievement.sub_achievement = data.subAchievement;
                    } else if (data.id === achievement.id && typeof data.subAchievement === 'object' && data.subAchievement !== null) {
                        // ê°ì²´ í˜•íƒœë¡œ ë°˜í™˜ë˜ëŠ” ê²½ìš°
                        achievement.sub_achievement = [data.subAchievement];
                    } else if (data.achievement_p && Array.isArray(data.achievement_p)) {
                        // achievement_p í•­ëª©ì„ ì„œë¸Œì—…ì ìœ¼ë¡œ ì‚¬ìš©
                        achievement.sub_achievement = data.achievement_p;
                    }
                }
                
                // ì„œë¸Œì—…ì  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ (ê°œë°œ ì¤‘ í…ŒìŠ¤íŠ¸ìš©)
                if (!achievement.sub_achievement || achievement.sub_achievement.length === 0) {
                    if (achievement.title && achievement.title.includes('2ì¼ì°¨')) {
                        console.log(`2ì¼ì°¨ ì—…ì ì— í…ŒìŠ¤íŠ¸ ì„œë¸Œì—…ì  ì¶”ê°€`);
                        // 2ì¼ì°¨ ì—…ì ì— í…ŒìŠ¤íŠ¸ ì„œë¸Œì—…ì  ì¶”ê°€
                        achievement.sub_achievement = [
                            {
                                id: `sub_${achievement.id}_1`,
                                title: 'ìš°ë¦¬ì§‘2',
                                description: 'ì§‘ì— ë°©ë¬¸í•˜ì„¸ìš”',
                                completed: true // ì´ ë¶€ë¶„ì´ ì¤‘ìš”: ì™„ë£Œëœ ì„œë¸Œì—…ì 
                            },
                            {
                                id: `sub_${achievement.id}_2`,
                                title: 'ì „ì£¼ì—¬í–‰ë¬¸í™”ê´€ì—…ì ',
                                description: 'ì „ì£¼ ì—¬í–‰ ë¬¸í™”ê´€ì— ë°©ë¬¸í•˜ì„¸ìš”'
                            }
                        ];
                    }
                }
                
                return achievement;
            } catch (error) {
                console.error(`ì—…ì  ID ${achievement.id}ì˜ ì„œë¸Œì—…ì  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, error);
                return achievement;
            }
        }

        // ì„œë¸Œì—…ì  í…ìŠ¤íŠ¸ ë¶„ì„ì„ í†µí•œ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ - ë¯¸ë¦¬ ì •ì˜
        function analyzeSubAchievementText(achievement) {
            if (!achievement || !achievement.sub_achievement) return achievement;
            
            const subAchievements = achievement.sub_achievement;
            let hasCompleted = false;
            let completedCount = 0;
            
            // ì„œë¸Œì—…ì ë³„ë¡œ í…ìŠ¤íŠ¸ ë¶„ì„
            subAchievements.forEach(sub => {
                // ì´ë¯¸ ìœ„ì˜ í•¨ìˆ˜ë¡œ ì™„ë£Œ ì—¬ë¶€ ì²´í¬í•œ ê²°ê³¼ ì‚¬ìš©
                const isCompleted = isSubAchievementCompleted(sub);
                if (isCompleted) {
                    completedCount++;
                    hasCompleted = true;
                    
                    // ì™„ë£Œ ì†ì„± ì¶”ê°€ (ì—†ì„ ê²½ìš°)
                    if (sub.completed !== true) {
                        sub.completed = true;
                    }
                }
            });
            
            // ë¶„ì„ ê²°ê³¼ ë¡œê¹…
            console.log(`ì—…ì  "${achievement.title || achievement.id}" ë¶„ì„ ê²°ê³¼:`, {
                completedCount,
                totalCount: subAchievements.length,
                hasCompletedSubAchievement: hasCompleted
            });
            
            // ë¶„ì„ ê²°ê³¼ ì¶”ê°€
            achievement.completedSubCount = completedCount;
            achievement.totalSubCount = subAchievements.length;
            achievement.hasCompletedSubAchievement = hasCompleted;
            
            return achievement;
        }

        // ì„œë¸Œì—…ì  ì™„ë£Œ ìƒíƒœ í™•ì¸ í•¨ìˆ˜
        function isSubAchievementCompleted(sub) {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¯¸ì™„ë£Œ ì²˜ë¦¬
            if (!sub) return false;
            
            // ì„œë¸Œì—…ì  ì™„ë£Œ ì—¬ë¶€ ê²€ì‚¬ë¥¼ ìœ„í•œ ë¡œê¹…
            console.log(`ì„œë¸Œì—…ì  "${sub.title || 'ì œëª© ì—†ìŒ'}" ì™„ë£Œ ì—¬ë¶€ ê²€ì‚¬:`, sub);
            
            // 1. achievement_p ê°ì²´ê°€ ìˆê³ , completeê°€ trueì¸ ê²½ìš° (ê°€ì¥ ëª…í™•í•œ ì¼€ì´ìŠ¤)
            if (sub.achievement_p && Array.isArray(sub.achievement_p) && sub.achievement_p.length > 0) {
                const hasComplete = sub.achievement_p.some(p => p.complete === true);
                if (hasComplete) {
                    console.log(`- achievement_p ë°°ì—´ì—ì„œ complete=true í•­ëª© ë°œê²¬`);
                    return true;
                }
            }
            
            // 2. ì§ì ‘ì ì¸ complete ì†ì„±ì´ ìˆëŠ” ê²½ìš°
            if (sub.complete === true) {
                console.log(`- complete=true ì†ì„± ë°œê²¬`);
                return true;
            }
            
            // 3. completed ì†ì„±ì´ ìˆëŠ” ê²½ìš°
            if (sub.completed === true) {
                console.log(`- completed=true ì†ì„± ë°œê²¬`);
                return true;
            }
            
            // 4. is_completed ì†ì„±ì´ ìˆëŠ” ê²½ìš°
            if (sub.is_completed === true) {
                console.log(`- is_completed=true ì†ì„± ë°œê²¬`);
                return true;
            }
            
            // 5. ìˆ«ì í˜•íƒœë¡œ ì™„ë£Œ ì—¬ë¶€ë¥¼ í‘œì‹œí•˜ëŠ” ê²½ìš°
            if (sub.complete === 1 || sub.completed === 1 || sub.is_completed === 1) {
                console.log(`- ìˆ«ì 1ë¡œ ì™„ë£Œ ìƒíƒœ í‘œì‹œ ë°œê²¬`);
                return true;
            }
            
            // 6. ì§„í–‰ë¥ ì´ 100%ì¸ ê²½ìš°
            if (sub.progress === 100 || sub.progress === '100') {
                console.log(`- ì§„í–‰ë¥  100% ë°œê²¬`);
                return true;
            }
            
            // 7. status ì†ì„±ì´ 'completed', 'done', 'finished' ë“±ì˜ ê°’ì„ ê°€ì§€ëŠ” ê²½ìš°
            if (sub.status && ['completed', 'done', 'finished', 'complete'].includes(sub.status.toLowerCase())) {
                console.log(`- status="${sub.status}" ë°œê²¬ (ì™„ë£Œ ìƒíƒœ)`);
                return true;
            }
            
            // 8. countì™€ totalì´ ìˆê³  count >= totalì¸ ê²½ìš° (ì§„í–‰ë¥  ê¸°ë°˜)
            if (sub.count !== undefined && sub.total !== undefined && Number(sub.count) >= Number(sub.total)) {
                console.log(`- count(${sub.count}) >= total(${sub.total}) ë°œê²¬`);
                return true;
            }
            
            // 9. done ì†ì„±ì´ ìˆëŠ” ê²½ìš°
            if (sub.done === true || sub.done === 1 || sub.done === 'true') {
                console.log(`- done=${sub.done} ì†ì„± ë°œê²¬`);
                return true;
            }
            
            // 10. ìƒíƒœ(state)ê°€ ì™„ë£Œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê²½ìš°
            if (sub.state && ['completed', 'done', 'finished', 'complete'].includes(sub.state.toLowerCase())) {
                console.log(`- state="${sub.state}" ë°œê²¬ (ì™„ë£Œ ìƒíƒœ)`);
                return true;
            }
            
            // 11. achievement_user_p ê°ì²´ê°€ ìˆê³  ê·¸ ì•ˆì— ì™„ë£Œ í‘œì‹œê°€ ìˆëŠ” ê²½ìš°
            if (sub.achievement_user_p) {
                if (Array.isArray(sub.achievement_user_p) && sub.achievement_user_p.length > 0) {
                    const userComplete = sub.achievement_user_p.some(p => 
                        p.complete === true || p.completed === true || p.is_completed === true);
                    if (userComplete) {
                        console.log(`- achievement_user_p ë°°ì—´ì—ì„œ ì™„ë£Œ í•­ëª© ë°œê²¬`);
                        return true;
                    }
                } else if (typeof sub.achievement_user_p === 'object') {
                    if (sub.achievement_user_p.complete || sub.achievement_user_p.completed || sub.achievement_user_p.is_completed) {
                        console.log(`- achievement_user_p ê°ì²´ì—ì„œ ì™„ë£Œ ì†ì„± ë°œê²¬`);
                        return true;
                    }
                }
            }
            
            // 12. ì½˜í…ì¸  ë‚´ìš©ì´ 'ì™„ë£Œ' ë˜ëŠ” 'ì„±ê³µ' ë‹¨ì–´ë¥¼ í¬í•¨í•˜ëŠ” ê²½ìš°
            if (typeof sub.content === 'string' && 
                (sub.content.includes('ì™„ë£Œ') || sub.content.includes('ì„±ê³µ'))) {
                console.log(`- ì½˜í…ì¸ ì— 'ì™„ë£Œ' ë˜ëŠ” 'ì„±ê³µ' ë‹¨ì–´ í¬í•¨`);
                return true;
            }
            
            // 13. "ì™„ë£Œí•¨" í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš° 
            if (sub.text === 'ì™„ë£Œí•¨' || sub.label === 'ì™„ë£Œí•¨' || 
                (typeof sub.description === 'string' && sub.description.includes('ì™„ë£Œí•¨'))) {
                console.log(`- 'ì™„ë£Œí•¨' í…ìŠ¤íŠ¸ ë°œê²¬`);
                return true;
            }
            
            // 14. íŠ¹ë³„ ì¼€ì´ìŠ¤: í•œê¸€ë¡œ 'ì™„ë£Œ' ê´€ë ¨ í…ìŠ¤íŠ¸
            if ((typeof sub.title === 'string' && sub.title.includes('ì™„ë£Œ')) ||
                (typeof sub.text === 'string' && sub.text.includes('ì™„ë£Œ')) ||
                (sub.description && sub.description.includes('ì™„ë£Œ'))) {
                console.log(`- í•œê¸€ 'ì™„ë£Œ' í…ìŠ¤íŠ¸ ë°œê²¬`);
                return true;
            }
            
            // 15. íŠ¹ë³„ ì¼€ì´ìŠ¤: ì²´í¬ í‘œì‹œê°€ ìˆëŠ” ê²½ìš°
            if (sub.text === 'âœ“' || sub.label === 'âœ“' || 
                (typeof sub.content === 'string' && sub.content.includes('âœ“'))) {
                console.log(`- ì²´í¬ í‘œì‹œ(âœ“) ë°œê²¬`);
                return true;
            }
            
            // 16. íŠ¹ë³„ ì¼€ì´ìŠ¤: í•‘í¬í† í”¼ì•„ íŠ¹í™” í•„ë“œ ê²€ì‚¬
            if (sub.ì™„ë£Œì—¬ë¶€ === true || sub.ì™„ë£Œì—¬ë¶€ === 'ì™„ë£Œ' || sub.ì™„ë£Œì—¬ë¶€ === 1) {
                console.log(`- ì™„ë£Œì—¬ë¶€ í•„ë“œ ë°œê²¬`);
                return true;
            }
            
            // 17. ì•„ë¬´ í”„ë¡œí¼í‹°ì—ì„œ ì™„ë£Œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°’ì„ ì°¾ê¸° (ë§ˆì§€ë§‰ ìˆ˜ë‹¨)
            for (const key in sub) {
                const value = sub[key];
                if (typeof value === 'boolean' && value === true && 
                    (key.includes('complete') || key.includes('done') || key.includes('finish'))) {
                    console.log(`- ${key}=true ì†ì„± ë°œê²¬ (ì™„ë£Œ ê´€ë ¨ í‚¤ì›Œë“œ)`);
                    return true;
                }
                
                // ë¬¸ìì—´ ê°’ì—ì„œ 'ì™„ë£Œ' ë‹¨ì–´ í™•ì¸
                if (typeof value === 'string' && 
                    (value.includes('ì™„ë£Œ') || value.includes('ì„±ê³µ') || value === 'âœ“')) {
                    console.log(`- ${key}="${value}" ì†ì„± ë°œê²¬ (ì™„ë£Œ ê´€ë ¨ í…ìŠ¤íŠ¸)`);
                    return true;
                }
            }
            
            console.log(`- ì„œë¸Œì—…ì  ì™„ë£Œ ì¡°ê±´ ì—†ìŒ (ë¯¸ì™„ë£Œ)`);
            // ëª¨ë“  ì¡°ê±´ì— í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ë¯¸ì™„ë£Œë¡œ ì²˜ë¦¬
            return false;
        }

        // APIì—ì„œ ì—…ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (chattingrooms.html ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
        async function fetchAchievements() {
            try {
                const accessToken = localStorage.getItem("accessToken");
                if (!accessToken) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
                    window.location.href = "/public/log-in.html";
                    return;
                }
                
                // Authorization í—¤ë” ì„¤ì • (chattingrooms.html ë°©ì‹)
                const headers = { "Authorization": accessToken };
                
                // 1. ì „ì²´ ì—…ì  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const allResponse = await fetch('/achievement', { headers });
                if (!allResponse.ok) {
                    throw new Error('ì—…ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                let allAchievementsData = await allResponse.json();
                let allAchievements = Array.isArray(allAchievementsData) ? allAchievementsData : [];
                console.log('ì „ì²´ ì—…ì  ë°ì´í„°:', allAchievements);
                
                // ì „ì²´ ì—…ì ì— ì„œë¸Œì—…ì  ë°ì´í„° ì¶”ê°€
                allAchievements = await Promise.all(
                    allAchievements.map(achievement => fetchSubAchievements(achievement))
                );
                
                // ì „ì²´ ì—…ì ì—ë„ ì„œë¸Œì—…ì  ë¶„ì„ ì ìš©
                allAchievements = allAchievements.map(analyzeSubAchievementText);
                
                // 2. ì™„ë£Œëœ ì—…ì  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                let completedAchievements = [];
                try {
                    const completedResponse = await fetch('/achievement/done', { headers });
                    if (completedResponse.ok) {
                        let completedData = await completedResponse.json();
                        completedAchievements = Array.isArray(completedData) ? completedData : [];
                        console.log('ì™„ë£Œëœ ì—…ì  ë°ì´í„°:', completedAchievements);
                        
                        // ì™„ë£Œëœ ì—…ì ì— ì„œë¸Œì—…ì  ë°ì´í„° ì¶”ê°€
                        completedAchievements = await Promise.all(
                            completedAchievements.map(achievement => fetchSubAchievements(achievement))
                        );
                        
                        // ì™„ë£Œëœ ì—…ì ì—ë„ ì„œë¸Œì—…ì  ë¶„ì„ ì ìš©
                        completedAchievements = completedAchievements.map(analyzeSubAchievementText);
                    } else {
                        console.warn('ì™„ë£Œëœ ì—…ì ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', completedResponse.status);
                    }
                } catch (err) {
                    console.error('ì™„ë£Œëœ ì—…ì  ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', err);
                }
                
                // 3. ì™„ë£Œëœ ì—…ì  ID ëª©ë¡ ìƒì„±
                const completedIds = completedAchievements.map(a => a.id);
                
                // 4. ì „ì²´ ì—…ì ì— ì™„ë£Œ ìƒíƒœ í‘œì‹œ
                allAchievements = allAchievements.map(achievement => ({
                    ...achievement,
                    is_completed: completedIds.includes(achievement.id)
                }));
                
                // 5. ì§„í–‰ ì¤‘ì¸ ì—…ì  ê°€ì ¸ì˜¤ê¸°
                let activeAchievements = [];
                try {
                    const activeResponse = await fetch('/achievement/active', { headers });
                    if (activeResponse.ok) {
                        let activeData = await activeResponse.json();
                        activeAchievements = Array.isArray(activeData) ? activeData : [];
                        
                        // ë°ì´í„° ë¡œê¹…ì— null, undefined ì²˜ë¦¬
                        console.log('ì§„í–‰ ì¤‘ì¸ ì—…ì  ë°ì´í„° (ì›ë³¸):', 
                            activeAchievements.map(a => ({
                                ...a,
                                title: a.title || '[ì œëª© ì—†ìŒ]',
                                description: a.description || '[ì„¤ëª… ì—†ìŒ]'
                            }))
                        );
                        
                        // ì§„í–‰ ì¤‘ì¸ ì—…ì ì—ì„œ ì™„ë£Œëœ ì—…ì  í•„í„°ë§ (ì¤‘ìš”)
                        activeAchievements = activeAchievements.filter(
                            achievement => !completedIds.includes(achievement.id)
                        );
                        console.log('ì§„í–‰ ì¤‘ì¸ ì—…ì  ë°ì´í„° (í•„í„°ë§ í›„):', activeAchievements);
                        
                        // ì§„í–‰ ì¤‘ì¸ ì—…ì ì— ì„œë¸Œì—…ì  ë°ì´í„° ì¶”ê°€
                        activeAchievements = await Promise.all(
                            activeAchievements.map(achievement => fetchSubAchievements(achievement))
                        );
                        
                        // ê° ì—…ì ì˜ ì„œë¸Œì—…ì  í…ìŠ¤íŠ¸ ë¶„ì„
                        activeAchievements = activeAchievements.map(analyzeSubAchievementText);
                        
                        // ì¤‘ìš”: ì„œë¸Œ ì—…ì ì´ ìµœì†Œ 1ê°œ ì´ìƒ ì™„ë£Œëœ ì—…ì ë§Œ í‘œì‹œ
                        const originalActiveCount = activeAchievements.length;
                        activeAchievements = activeAchievements.filter(achievement => {
                            // ì„œë¸Œì—…ì ì´ ì—†ëŠ” ê²½ìš° ì œì™¸
                            const subAchievements = achievement.sub_achievement || [];
                            if (subAchievements.length === 0) {
                                console.log(`ì—…ì  "${achievement.title || achievement.id}" ì œì™¸: ì„œë¸Œì—…ì  ì—†ìŒ`);
                                return false;
                            }
                            
                            // ë¶„ì„ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
                            if (achievement.hasCompletedSubAchievement !== undefined) {
                                const result = achievement.hasCompletedSubAchievement;
                                console.log(`ì—…ì  "${achievement.title || achievement.id}" ${result ? 'í¬í•¨' : 'ì œì™¸'}: ë¶„ì„ ê²°ê³¼ ì‚¬ìš©`);
                                return result;
                            }
                            
                            // ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ í™•ì¸
                            const hasCompleted = subAchievements.some(sub => isSubAchievementCompleted(sub));
                            console.log(`ì—…ì  "${achievement.title || achievement.id}" ${hasCompleted ? 'í¬í•¨' : 'ì œì™¸'}: ê¸°ì¡´ ë°©ì‹ í™•ì¸`);
                            return hasCompleted;
                        });
                        
                        console.log(`ì§„í–‰ ì¤‘ì¸ ì—…ì  í•„í„°ë§ ê²°ê³¼: ${originalActiveCount}ê°œ ì¤‘ ${activeAchievements.length}ê°œ í‘œì‹œë¨`);
                    } else {
                        console.warn('ì§„í–‰ ì¤‘ì¸ ì—…ì ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', activeResponse.status);
                    }
                } catch (err) {
                    console.error('ì§„í–‰ ì¤‘ì¸ ì—…ì  ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', err);
                }
                
                // 6. ì—…ì  ëª©ë¡ ë Œë”ë§
                renderAchievements('all-achievements', allAchievements);
                renderAchievements('active-achievements', activeAchievements);
                renderAchievements('completed-achievements', completedAchievements);
            } catch (error) {
                console.error('ì—…ì  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê° ëª©ë¡ì— ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('all-achievements').innerHTML = '<div class="empty-state">ì—…ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                document.getElementById('active-achievements').innerHTML = '<div class="empty-state">ì—…ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                document.getElementById('completed-achievements').innerHTML = '<div class="empty-state">ì—…ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì—…ì  ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤
        function renderAchievements(containerId, achievements) {
            const container = document.getElementById(containerId);
            
            if (!achievements || achievements.length === 0) {
                if (containerId === 'active-achievements') {
                    container.innerHTML = '<div class="info-message" style="background-color: #fff6f6; border-left: 3px solid #ff69b4; padding: 10px; margin-bottom: 15px; border-radius: 5px;"><p style="margin: 0; color: #333;">ì§„í–‰ ì¤‘ì¸ ì—…ì ì€ <strong>ìµœì†Œ 1ê°œ ì´ìƒì˜ ì„œë¸Œì—…ì ì´ ì™„ë£Œëœ</strong> ì—…ì ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p></div><div class="empty-state">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì„œë¸Œ ì—…ì ì„ í•˜ë‚˜ ì´ìƒ ì™„ë£Œí•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
                } else {
                    container.innerHTML = '<div class="empty-state">ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                return;
            }
            
            let html = '';
            
            achievements.forEach(achievement => {
                // ì„œë¸Œ ì—…ì  ê°€ì ¸ì˜¤ê¸°
                let subAchievementsHtml = '';
                
                // ì„œë¸Œì—…ì ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì—¬ëŸ¬ ê²½ìš°ì˜ êµ¬ì¡° ì²˜ë¦¬)
                const subAchievements = achievement.sub_achievement || [];
                
                // ì§„í–‰ë¥  ê³„ì‚° (ê°œì„ ëœ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ ì‚¬ìš©)
                let completedCount = 0;
                let totalCount = subAchievements ? subAchievements.length : 0;
                
                // ì—…ì  ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (ì—…ì  ìì²´ì˜ ì™„ë£Œìƒíƒœ ë˜ëŠ” ì„œë¸Œì—…ì ìœ¼ë¡œ íŒë‹¨)
                const isCompletedTab = containerId === 'completed-achievements';
                const isCompleted = isCompletedTab || achievement.is_completed || 
                    (subAchievements.length > 0 && subAchievements.every(sub => isSubAchievementCompleted(sub)));
                
                // ì™„ë£Œëœ ì—…ì ì— ëŒ€í•œ ì¶”ê°€ í´ë˜ìŠ¤ì™€ ì•„ì´ì½˜
                const completedClass = isCompleted ? 'completed-achievement' : '';
                const completedIcon = isCompleted ? '<span class="completed-badge">âœ“</span>' : '';
                
                if (subAchievements && subAchievements.length > 0) {
                    subAchievements.forEach(sub => {
                        // ì™„ë£Œëœ ì—…ì  íƒ­ì—ì„œë§Œ ëª¨ë‘ ì™„ë£Œë¡œ í‘œì‹œ, ë‹¤ë¥¸ íƒ­ì—ì„œëŠ” ì‹¤ì œ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
                        let isSubCompleted = isCompletedTab || achievement.is_completed || isSubAchievementCompleted(sub);
                        
                        if (isSubCompleted) {
                            completedCount++;
                        }
                        
                        // ì„œë¸Œì—…ì  í•­ëª© í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ìœ„í•´ data-sub-id ì¶”ê°€
                        const subId = sub.id || '';
                        
                        // ì™„ë£Œ ìƒíƒœ ë””ë²„ê¹…ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€
                        const statusClass = isSubCompleted ? 'completed' : '';
                        
                        // ì„œë¸Œì—…ì ì— ëŒ€í•œ ì„¤ëª… ì¶”ê°€
                        const subDescription = sub.description || sub.content || 'ì„¸ë¶€ ëª©í‘œ';
                        
                        // ì›Œí¬í”Œë¡œìš° ì„¤ëª… ì¶”ê°€ (ì„œë¸Œì—…ì  â†’ ì—…ì P â†’ ì—…ì C)
                        let workflowInfo = '';
                        if (isSubCompleted) {
                            workflowInfo = '<div class="sub-item-workflow completed">ì™„ë£Œë¨ âœ“</div>';
                        } else {
                            if (containerId === 'active-achievements') {
                                workflowInfo = '<div class="sub-item-workflow">ì§„í–‰ ì¤‘ì¸ ëª©í‘œì…ë‹ˆë‹¤</div>';
                            } else {
                                workflowInfo = '<div class="sub-item-workflow">ì™„ë£Œ ì‹œ ì—…ì ì— ê¸°ë¡ë©ë‹ˆë‹¤</div>';
                            }
                        }
                        
                        subAchievementsHtml += `
                            <div class="sub-item ${statusClass}" data-sub-id="${subId}">
                                <div class="sub-item-check">${isSubCompleted ? 'âœ“' : ''}</div>
                                <div class="sub-item-content">
                                    <div class="sub-item-text">${sub.title || 'ì—…ì  ì œëª© ì—†ìŒ'}</div>
                                    <div class="sub-item-description">${subDescription || 'ì´ ì—…ì ì— ëŒ€í•œ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                                    ${workflowInfo}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    subAchievementsHtml = '<div class="empty-state">ì„œë¸Œ ì—…ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
                let progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                
                // ì™„ë£Œëœ ì—…ì  íƒ­ì— í‘œì‹œë˜ëŠ” ê²½ìš° ë¬´ì¡°ê±´ 100%ë¡œ ì„¤ì •
                if (isCompletedTab) {
                    progressPercent = 100;
                    completedCount = totalCount;
                }
                
                // ë³´ìƒ ì •ë³´ íŒŒì‹±
                let rewardHtml = '';
                if (achievement.reward) {
                    let reward;
                    if (typeof achievement.reward === 'string') {
                        try {
                            reward = JSON.parse(achievement.reward);
                        } catch (e) {
                            // ë¬¸ìì—´ì´ì§€ë§Œ JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ
                            const gemMatch = achievement.reward.match(/gem[:\s]*(\d+)/i);
                            const diaMatch = achievement.reward.match(/dia[:\s]*(\d+)/i);
                            
                            reward = { 
                                gem: gemMatch ? parseInt(gemMatch[1]) : 0,
                                dia: diaMatch ? parseInt(diaMatch[1]) : 0
                            };
                        }
                    } else {
                        reward = achievement.reward;
                    }
                    
                    if (reward.gem && reward.gem > 0) {
                        rewardHtml += `
                            <div class="reward-item">
                                <img src="/public/images/gem.png" alt="Gem"> ${reward.gem}
                            </div>
                        `;
                    }
                    
                    if (reward.dia && reward.dia > 0) {
                        rewardHtml += `
                            <div class="reward-item">
                                <img src="/public/images/dia.png" alt="Diamond"> ${reward.dia}
                            </div>
                        `;
                    }
                }
                
                html += `
                    <div class="achievement-item">
                        <div class="achievement-header" onclick="toggleAchievement(this)">
                            <div class="achievement-title-container">
                                <span class="achievement-title">${achievement.title || `ì—…ì  #${achievement.id || 'ì•Œ ìˆ˜ ì—†ìŒ'}`}</span>
                                <span class="achievement-progress-percent">${progressPercent.toFixed(2)}%</span>
                            </div>
                            <div class="achievement-category">${achievement.category || 'COMMON'}</div>
                        </div>
                        <div class="achievement-content ${isCompleted ? 'active' : ''}">
                            <div class="achievement-description">${achievement.description || 'ì´ ì—…ì ì— ëŒ€í•œ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            <div class="reward-info">${rewardHtml}</div>
                            <div class="sub-achievements">
                                <h4>ì„œë¸Œ ì—…ì </h4>
                                ${subAchievementsHtml}
                            </div>
                            <div class="achievement-progress">
                                <div class="progress-bar">
                                    <div class="progress-filled" style="width: ${progressPercent}%"></div>
                                </div>
                                <span class="progress-count">${completedCount} / ${totalCount}</span>
                            </div>
                            <div class="expiry-date">ë§Œë£Œì¼: ${achievement.expiryDate ? new Date(achievement.expiryDate).toLocaleDateString() : 'ë¬´ê¸°í•œ'}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>