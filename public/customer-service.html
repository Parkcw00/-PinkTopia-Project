<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê°ì„¼í„° | PinkTopia</title>
    <link rel="stylesheet" href="/public/styles.css" />
    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ff69b4;
            padding: 15px;
            color: white;
            font-weight: bold;
            position: relative;
            height: 50px;
        }

        /* í–„ë²„ê±° ë©”ë‰´ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .menu-icon {
            position: absolute;
            left: 15px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            z-index: 2;
        }

        .menu-icon .hamburger {
            width: 25px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .menu-icon .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background-color: white;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        /* ë¡œê³  ìŠ¤íƒ€ì¼ */
        .nav .logo-container {
            position: absolute;
            left: 50px;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .nav img {
            width: 45px;
            height: 45px;
            object-fit: cover;
        }

        .logo-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
        }

        #authMenu {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ë§í¬ ìŠ¤íƒ€ì¼ */
        .nav a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #ff69b4;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
        }

        .sidebar a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar a:hover {
            background-color: #ff4da6;
        }

        .close-sidebar {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
            color: white;
        }

        .sidebar-header {
            padding: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .inquiry-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-group textarea {
            height: 150px;
            resize: vertical;
        }

        .submit-button {
            background-color: #ff69b4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-button:hover {
            background-color: #ff4da6;
        }

        .inquiry-history {
            margin-top: 40px;
        }

        .inquiry-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .inquiry-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .status-pending {
            background-color: #ffd700;
            color: #000;
        }

        .status-completed {
            background-color: #90ee90;
            color: #000;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .detail-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .detail-button:hover {
            background-color: #357abd;
        }

        #userProfileBox {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #ff5faf;
            font-weight: bold;
            font-size: 16px;
        }

        #userProfileBox img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 2px solid #ff7fbf;
        }
    </style>
</head>

<body>
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="nav">
        <div class="menu-icon" onclick="openSidebar()">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        <div class="logo-container">
            <img src="./images/123.jpg" alt="PinkTopia Logo" />
        </div>
        <div class="logo-text">
            <a href="/public/home.html" style="text-decoration: none; color: white">PinkTopia</a>
        </div>
        <div id="authMenu" style="margin-left: auto; display: flex; align-items: center"></div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="close-sidebar" onclick="closeSidebar()">&times;</span>
        </div>
        <div class="sidebar-content">
            <a href="/public/home.html">í™ˆ</a>
            <a href="/public/event.html">ì´ë²¤íŠ¸</a>
            <a href="/public/store-item.html">ì•„ì´í…œìƒµ</a>
            <a href="/public/board.html">ê²Œì‹œê¸€ (ì»¤ë®¤ë‹ˆí‹°)</a>
            <a href="/public/ranking.html">ë­í‚¹</a>
            <a href="/public/customer-service.html">ë¬¸ì˜ì„¼í„°</a>
            <div id="loggedInMenu" style="display: none">
                <a href="/public/chattingrooms.html">ì±„íŒ…</a>
                <a href="/public/collection.html">í•‘í¬ëª½ ê°œì¸ ë„ê°</a>
                <a href="/public/inventory.html">ì¸ë²¤í† ë¦¬ ì•„ì´í…œ</a>
                <a href="/public/achievements.html">ì—…ì </a>
                <a href="/public/mypage.html">ë§ˆì´í˜ì´ì§€</a>
                <a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <div id="loggedOutMenu">
                <a href="/public/log-in.html">ë¡œê·¸ì¸</a>
                <a href="/public/sign-up.html">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>ê³ ê°ì„¼í„°</h1>

        <!-- ë¬¸ì˜í•˜ê¸° í¼ -->
        <div class="inquiry-form">
            <h2>ë¬¸ì˜í•˜ê¸°</h2>
            <form id="inquiryForm">
                <div class="form-group">
                    <label for="inquiryType">ë¬¸ì˜ ìœ í˜•</label>
                    <select id="inquiryType" name="inquiryType" required>
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="refund">í™˜ë¶ˆ ìš”ì²­</option>
                        <option value="payment">ê²°ì œ ë¬¸ì˜</option>
                        <option value="bug">ë²„ê·¸ ì‹ ê³ </option>
                        <option value="suggestion">ê¸°ëŠ¥ ì œì•ˆ</option>
                        <option value="other">ê¸°íƒ€ ë¬¸ì˜</option>
                    </select>
                </div>

                <!-- í™˜ë¶ˆ ìš”ì²­ ì‹œì—ë§Œ í‘œì‹œë˜ëŠ” í•„ë“œë“¤ -->
                <div id="refundFields" style="display: none;">
                    <div class="form-group">
                        <label for="purchaseHistory">êµ¬ë§¤ ë‚´ì—­</label>
                        <select id="purchaseHistory" name="purchaseHistory" required>
                            <option value="">êµ¬ë§¤ ë‚´ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            * í™˜ë¶ˆí•˜ê³  ì‹¶ì€ ê²°ì œ ë‚´ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="refundReason">í™˜ë¶ˆ ì‚¬ìœ </label>
                        <select id="refundReason" name="refundReason" required>
                            <option value="">í™˜ë¶ˆ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="ì‹¤ìˆ˜ë¡œ êµ¬ë§¤">ì‹¤ìˆ˜ë¡œ êµ¬ë§¤</option>
                            <option value="ìƒí’ˆ ë¶ˆë§Œì¡±">ìƒí’ˆ ë¶ˆë§Œì¡±</option>
                            <option value="ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€">ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="title">ì œëª©</label>
                    <input type="text" id="title" name="title" required placeholder="ë¬¸ì˜ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                </div>

                <div class="form-group">
                    <label for="content">ë‚´ìš©</label>
                    <textarea id="content" name="content" required placeholder="ìì„¸í•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                </div>

                <div class="form-group" id="attachmentField">
                    <label for="attachment">ì²¨ë¶€íŒŒì¼ (ì„ íƒ)</label>
                    <input type="file" id="attachment" name="attachment" accept="image/*">
                </div>

                <button type="submit" class="submit-button">ë¬¸ì˜í•˜ê¸°</button>
            </form>
        </div>

        <!-- ë¬¸ì˜ ë‚´ì—­ -->
        <div class="inquiry-history">
            <h2>ë‚˜ì˜ ë¬¸ì˜ ë‚´ì—­</h2>
            <div id="inquiryList">
                <!-- ë¬¸ì˜ ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="inquiryModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // ì‚¬ì´ë“œë°” ì—´ê¸° í•¨ìˆ˜
        function openSidebar() {
            document.getElementById('sidebar').style.width = '250px';
        }

        // ì‚¬ì´ë“œë°” ë‹«ê¸° í•¨ìˆ˜
        function closeSidebar() {
            document.getElementById('sidebar').style.width = '0';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë©”ë‰´ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function () {
            const accessToken = localStorage.getItem('accessToken');
            const authMenu = document.getElementById('authMenu');

            if (accessToken) {
                // ì‚¬ì´ë“œë°” ë©”ë‰´ ì—…ë°ì´íŠ¸
                document.getElementById('loggedInMenu').style.display = 'block';
                document.getElementById('loggedOutMenu').style.display = 'none';

                // ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ë©”ë‰´ ì—…ë°ì´íŠ¸
                authMenu.innerHTML = `
                    <a href="/public/mypage.html">ë§ˆì´í˜ì´ì§€</a>
                    <a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
                `;

                // ë©”ì¸ ë©”ë‰´ì— ë¡œê·¸ì¸ ìƒíƒœì—ì„œë§Œ ë³´ì´ëŠ” ë©”ë‰´ ì¶”ê°€
                const menuList = document.getElementById('menuList');
                if (menuList.querySelectorAll('a').length === 5) {
                    // ê¸°ë³¸ ë©”ë‰´ë§Œ ìˆëŠ” ê²½ìš°
                    menuList.innerHTML += `
                        <a href="/public/chattingrooms.html">ì±„íŒ…</a>
                        <a href="/public/collection.html">í•‘í¬ëª½ ê°œì¸ ë„ê°</a>
                        <a href="/public/inventory.html">ì¸ë²¤í† ë¦¬ ì•„ì´í…œ</a>
                        <a href="/public/achievements.html">ì—…ì </a>
                    `;
                }
            } else {
                // ì‚¬ì´ë“œë°” ë©”ë‰´ ì—…ë°ì´íŠ¸
                document.getElementById('loggedInMenu').style.display = 'none';
                document.getElementById('loggedOutMenu').style.display = 'block';

                // ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ë©”ë‰´ ì—…ë°ì´íŠ¸
                authMenu.innerHTML = `
                    <a href="/public/log-in.html">ë¡œê·¸ì¸</a>
                    <a href="/public/sign-up.html">íšŒì›ê°€ì…</a>
                `;
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
        });

        function checkLoginStatus() {
            const accessToken = localStorage.getItem('accessToken');
            const authMenu = document.getElementById('authMenu');

            if (accessToken) {
                fetch('/user/me', {
                    headers: { Authorization: accessToken },
                })
                    .then((response) => response.json())
                    .then((userData) => {
                        const profileImage =
                            userData.profile_image || './images/default-profile.png'; // ê¸°ë³¸ ì´ë¯¸ì§€

                        authMenu.innerHTML = `
                    <div id="userProfileBox" onclick="goToProfile()" style="cursor: pointer;">
                    <img src="${profileImage}" alt="í”„ë¡œí•„ ì‚¬ì§„">
                    <span><span class="welcome-text">í™˜ì˜í•©ë‹ˆë‹¤!</span> <strong>${userData.nickname}</strong>ë‹˜!</span>
                    </div>
                    <a href="#" onclick="logout()" style="margin-left: 15px; color: white; text-decoration: none;">ë¡œê·¸ì•„ì›ƒ</a>
                `;
                    })
                    .catch((error) => {
                        console.error('ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                        authMenu.innerHTML = `<a href="/public/log-in.html" style="color: white;">ë¡œê·¸ì¸</a> / <a href="/public/sign-up.html" style="color: white;">íšŒì›ê°€ì…</a>`;
                    });
            } else {
                authMenu.innerHTML = `<a href="/public/log-in.html" style="color: white;">ë¡œê·¸ì¸</a> / <a href="/public/sign-up.html" style="color: white;">íšŒì›ê°€ì…</a>`;
            }
        }

        function goToProfile() {
            window.location.href = '/public/mypage.html';
        }

        async function logout() {
            try {
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    console.warn('ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹œë„: ì´ë¯¸ ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœ');
                    window.location.href = '/public/log-in.html';
                    return;
                }

                // ğŸ”¹ ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ë³´ë‚´ê¸°
                const response = await fetch('/user/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: accessToken,
                    },
                    credentials: 'include', // ì¿ í‚¤ë„ í•¨ê»˜ ë³´ë‚´ê¸°
                });

                if (!response.ok) {
                    throw new Error('ì„œë²„ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨');
                }
                localStorage.removeItem('accessToken');
                console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ! í˜ì´ì§€ ì´ë™');
                window.location.href = '/';
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ì„ ì „ì—­ ìŠ¤ì½”í”„ë¡œ ì´ë™
        function openModal(inquiry) {
            const modal = document.getElementById('inquiryModal');
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
    <h2>${inquiry.title}</h2>
    <div style="margin: 10px 0;">
        <span class="inquiry-status ${inquiry.status === 'pending' ? 'status-pending' : 'status-completed'}">
            ${inquiry.status === 'pending' ? 'ì²˜ë¦¬ì¤‘' : 'ë‹µë³€ì™„ë£Œ'}
        </span>
        <small style="margin-left: 10px;">${new Date(inquiry.createdAt).toLocaleString()}</small>
    </div>
    <div style="margin: 20px 0;">
        <strong>ë¬¸ì˜ ìœ í˜•:</strong> ${inquiry.type === 'refund' ? 'í™˜ë¶ˆ ìš”ì²­' :
                    inquiry.type === 'payment' ? 'ê²°ì œ ë¬¸ì˜' :
                        inquiry.type === 'bug' ? 'ë²„ê·¸ ì‹ ê³ ' :
                            inquiry.type === 'suggestion' ? 'ê¸°ëŠ¥ ì œì•ˆ' : 'ê¸°íƒ€ ë¬¸ì˜'
                }
    </div>
    <div style="margin: 20px 0;">
        <strong>ë¬¸ì˜ ë‚´ìš©:</strong>
        <p style="white-space: pre-wrap;">${inquiry.content}</p>
    </div>
    ${inquiry.attachmentUrl ? `
    <div style="margin: 20px 0;">
        <strong>ì²¨ë¶€íŒŒì¼:</strong><br>
        <img src="${inquiry.attachmentUrl}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" style="max-width: 100%; margin-top: 10px; border-radius: 4px;">
    </div>
    ` : ''}
    ${inquiry.type === 'refund' ? `
    <div style="margin: 20px 0;">
        <strong>í™˜ë¶ˆ ì •ë³´:</strong>
        <p>ê²°ì œ í‚¤: ${inquiry.paymentKey}</p>
        <p>í™˜ë¶ˆ ì‚¬ìœ : ${inquiry.refundReason}</p>
        <p>í™˜ë¶ˆ ê¸ˆì•¡: ${inquiry.amount?.toLocaleString()}ì›</p>
    </div>
    ` : ''}
    ${inquiry.answer ? `
    <div style="margin: 20px 0; padding-top: 20px; border-top: 1px solid #eee;">
        <strong>ë‹µë³€:</strong>
        <p style="white-space: pre-wrap;">${inquiry.answer}</p>
    </div>
    ` : ''}
    `;

            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('inquiryModal');
            modal.style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function (event) {
            const modal = document.getElementById('inquiryModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = '/public/log-in.html';
                return;
            }

            // ë¬¸ì˜ ìœ í˜• ì„ íƒì— ë”°ë¥¸ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
            const inquiryType = document.getElementById('inquiryType');
            const refundFields = document.getElementById('refundFields');

            // ê²°ì œ ë‚´ì—­ ë¡œë“œ
            async function loadPurchaseHistory() {
                try {
                    const response = await fetch('/payment/history', {
                        headers: {
                            'Authorization': accessToken
                        }
                    });

                    if (!response.ok) {
                        throw new Error('ê²°ì œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const purchases = await response.json();
                    const purchaseSelect = document.getElementById('purchaseHistory');

                    // ê²°ì œ ë‚´ì—­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì˜µì…˜ ì¶”ê°€
                    if (purchases.length > 0) {
                        purchaseSelect.innerHTML = `
    <option value="">ê²°ì œ ë‚´ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
    ${purchases.map(purchase => {
                            const isDisabled = purchase.isRefunded || purchase.usedDiamonds > 0;
                            const disabledReason = purchase.isRefunded ? ' (í™˜ë¶ˆì™„ë£Œ)' :
                                purchase.usedDiamonds > 0 ? ` (${purchase.usedDiamonds}ê°œ ì‚¬ìš©ë¨)` : '';

                            return `
    <option value="${purchase.paymentKey}" data-purchase='${JSON.stringify({
                                amount: purchase.amount,
                                remainingDiamonds: purchase.remainingDiamonds,
                                usedDiamonds: purchase.usedDiamonds
                            })}' ${isDisabled ? 'disabled' : ''}>
        ${purchase.itemName} - ${new Date(purchase.createdAt).toLocaleDateString()}
        ${disabledReason}
    </option>
    `;
                        }).join('')}
    `;
                    } else {
                        purchaseSelect.innerHTML = '<option value="">í™˜ë¶ˆ ê°€ëŠ¥í•œ ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</option>';
                    }
                } catch (error) {
                    console.error('ê²°ì œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            inquiryType.addEventListener('change', () => {
                const isRefundType = inquiryType.value === 'refund';
                refundFields.style.display = isRefundType ? 'block' : 'none';

                // í™˜ë¶ˆ ìš”ì²­ ì‹œ ì²¨ë¶€íŒŒì¼ í•„ë“œ ìˆ¨ê¹€
                const attachmentField = document.getElementById('attachmentField');
                attachmentField.style.display = isRefundType ? 'none' : 'block';

                // í™˜ë¶ˆ ê´€ë ¨ í•„ë“œë“¤ì˜ required ì†ì„± ë™ì  ì²˜ë¦¬
                const purchaseHistorySelect = document.getElementById('purchaseHistory');
                const refundReasonSelect = document.getElementById('refundReason');

                purchaseHistorySelect.required = isRefundType;
                refundReasonSelect.required = isRefundType;

                if (isRefundType) {
                    loadPurchaseHistory();
                    // í™˜ë¶ˆ ìš”ì²­ ì‹œ ì²¨ë¶€íŒŒì¼ ë¹„ìš°ê¸°
                    document.getElementById('attachment').value = '';
                }
            });

            // URLì—ì„œ ê²°ì œ í‚¤ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const paymentKey = urlParams.get('paymentKey');
            if (paymentKey) {
                inquiryType.value = 'refund';
                refundFields.style.display = 'block';

                // í™˜ë¶ˆ ìš”ì²­ ì‹œ ì²¨ë¶€íŒŒì¼ í•„ë“œ ìˆ¨ê¹€
                const attachmentField = document.getElementById('attachmentField');
                attachmentField.style.display = 'none';

                loadPurchaseHistory().then(() => {
                    const purchaseSelect = document.getElementById('purchaseHistory');
                    purchaseSelect.value = paymentKey;
                });
            }

            // ë¬¸ì˜í•˜ê¸° í¼ ì œì¶œ
            const inquiryForm = document.getElementById('inquiryForm');
            inquiryForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                try {
                    const data = {
                        type: inquiryType.value,
                        title: document.getElementById('title').value,
                        content: document.getElementById('content').value
                    };

                    if (inquiryType.value === 'refund') {
                        const purchaseSelect = document.getElementById('purchaseHistory');
                        const refundReasonSelect = document.getElementById('refundReason');

                        if (!purchaseSelect.value) {
                            throw new Error('í™˜ë¶ˆí•  ê²°ì œ ë‚´ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        }
                        if (!refundReasonSelect.value) {
                            throw new Error('í™˜ë¶ˆ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        }

                        const selectedOption = purchaseSelect.options[purchaseSelect.selectedIndex];
                        if (!selectedOption || !selectedOption.dataset.purchase) {
                            throw new Error('ì„ íƒëœ ê²°ì œ ë‚´ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }

                        try {
                            const purchaseData = JSON.parse(selectedOption.dataset.purchase);
                            if (!purchaseData.amount || typeof purchaseData.amount !== 'number') {
                                throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ê²°ì œ ê¸ˆì•¡ì…ë‹ˆë‹¤.');
                            }

                            // ë‹¤ì´ì•„ëª¬ë“œ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
                            if (purchaseData.usedDiamonds > 0) {
                                throw new Error(`ì´ë¯¸ ${purchaseData.usedDiamonds}ê°œì˜ ë‹¤ì´ì•„ëª¬ë“œê°€ ì‚¬ìš©ë˜ì–´ í™˜ë¶ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                            }

                            data.paymentKey = purchaseSelect.value;
                            data.refundReason = refundReasonSelect.value;
                            data.amount = purchaseData.amount;
                            data.remainingDiamonds = purchaseData.remainingDiamonds;
                        } catch (error) {
                            console.error('ê²°ì œ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
                            throw new Error('ê²°ì œ ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    }

                    // í™˜ë¶ˆ ìš”ì²­ ì—¬ë¶€ í™•ì¸
                    const isRefundType = inquiryType.value === 'refund';

                    // ì²¨ë¶€íŒŒì¼ì´ ìˆê³  í™˜ë¶ˆ ìš”ì²­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ FormData ì‚¬ìš©
                    const attachment = document.getElementById('attachment').files[0];
                    if (attachment && !isRefundType) {
                        const formData = new FormData();
                        // ì¼ë°˜ ë°ì´í„° ì¶”ê°€
                        formData.append('type', data.type);
                        formData.append('title', data.title);
                        formData.append('content', data.content);

                        // ì²¨ë¶€íŒŒì¼ ì¶”ê°€
                        formData.append('attachment', attachment);

                        const response = await fetch('/inquiry', {
                            method: 'POST',
                            headers: {
                                'Authorization': accessToken
                            },
                            body: formData
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        // ì²¨ë¶€íŒŒì¼ì´ ì—†ê±°ë‚˜ í™˜ë¶ˆ ìš”ì²­ì¸ ê²½ìš° JSONìœ¼ë¡œ ì „ì†¡

                        // í™˜ë¶ˆ ìš”ì²­ì¸ ê²½ìš° í™˜ë¶ˆ ê´€ë ¨ ë°ì´í„° ì¶”ê°€
                        let requestData = { ...data }; // data ê°ì²´ ë³µì‚¬

                        const response = await fetch('/inquiry', {
                            method: 'POST',
                            headers: {
                                'Authorization': accessToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    }

                    alert('ë¬¸ì˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    inquiryForm.reset();
                    loadInquiries(); // ë¬¸ì˜ ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
                } catch (error) {
                    console.error('ë¬¸ì˜ ë“±ë¡ ì‹¤íŒ¨:', error);
                    alert(error.message || 'ë¬¸ì˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });

            // ë¬¸ì˜ ë‚´ì—­ ë¡œë“œ
            async function loadInquiries() {
                try {
                    const response = await fetch('/inquiry/my', {
                        headers: {
                            'Authorization': accessToken
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const inquiries = await response.json();
                    const inquiryList = document.getElementById('inquiryList');
                    inquiryList.innerHTML = inquiries.map(inquiry => `
    <div class="inquiry-item">
        <span class="inquiry-status ${inquiry.status === 'pending' ? 'status-pending' : 'status-completed'}">
            ${inquiry.status === 'pending' ? 'ì²˜ë¦¬ì¤‘' : 'ë‹µë³€ì™„ë£Œ'}
        </span>
        <h3>${inquiry.title}</h3>
        <p>${inquiry.content.length > 100 ? inquiry.content.substring(0, 100) + '...' : inquiry.content}</p>
        <small>${new Date(inquiry.createdAt).toLocaleDateString()}</small>
        <div style="text-align: right;">
            <button class="detail-button" onclick='openModal(${JSON.stringify(inquiry)})'>
                ìƒì„¸ë³´ê¸°
            </button>
        </div>
    </div>
    `).join('');
                } catch (error) {
                    console.error('ë¬¸ì˜ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert(error.message || 'ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì´ˆê¸° ë¬¸ì˜ ë‚´ì—­ ë¡œë“œ
            loadInquiries();
        });

    </script>
</body>

</html>