<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1</title>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5dc1bc6ffb574e60204390643bad8557"></script>
  <script>
    let map, userMarker;

    function getStoredLocation() {
      return JSON.parse(localStorage.getItem('userLocation'));
    }

    function storeLocation(lat, lng) {
      localStorage.setItem('userLocation', JSON.stringify({ lat, lng, timestamp: Date.now() }));
    }

    function shouldRequestNewLocation() {
      const storedLocation = getStoredLocation();
      return !storedLocation || (Date.now() - storedLocation.timestamp > 5 * 60 * 1000);
    }

    function initializeMap(lat, lng) {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 5
      });
      map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

      userMarker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map: map,
        title: "내 위치",
        zIndex: 3
      });

      addMarkers();
    }

    function addMarkers() {
      const markerData = [
        { lat: 36.3275, lng: 127.4268, imageUrl: 'https://blog.kakaocdn.net/dn/ch0TFq/btsMojyLajz/bWu5fv0Ox11EuAlSI9RxA1/img.png', info: '출발!', draggable: true },
        { lat: 36.3260, lng: 127.4268, imageUrl: 'https://blog.kakaocdn.net/dn/ch0TFq/btsMojyLajz/bWu5fv0Ox11EuAlSI9RxA1/img.png', info: '도착', draggable: true },
        { lat: 36.340309, lng: 127.389999, imageUrl: 'https://blog.kakaocdn.net/dn/N5k03/btsMn0l4BNf/0Lk5if43ncFTjl9rzKCE61/img.png', info: '북마커 위치', draggable: false }
      ];

      markerData.forEach(({ lat, lng, imageUrl, info, draggable }) => {
        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lng),
          image: new kakao.maps.MarkerImage(imageUrl, new kakao.maps.Size(100, 100)),
          map: map,
          draggable: draggable
        });

        const infowindow = new kakao.maps.InfoWindow({
          content: `<div style="padding:5px;">${info} <br>
                    <a href="https://map.kakao.com/link/map/${info},${lat},${lng}" target="_blank" style="color:skyblue">큰지도보기</a>
                    <a href="https://map.kakao.com/link/to/${info},${lat},${lng}" target="_blank" style="color:blue">길찾기</a></div>`
        });
        infowindow.open(map, marker);
      });
    }

    // 사용자 위치 가져오기
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        ({ coords: { latitude, longitude } }) => {
          storeLocation(latitude, longitude);
          initializeMap(latitude, longitude);
        },
        error => console.error("위치 정보를 가져올 수 없습니다: ", error),
        { enableHighAccuracy: true }
      );

      navigator.geolocation.watchPosition(
        ({ coords: { latitude, longitude } }) => {
          const newPos = new kakao.maps.LatLng(latitude, longitude);
          userMarker.setPosition(newPos);
          storeLocation(latitude, longitude);
        },
        error => console.error("실시간 위치 업데이트 실패: ", error),
        { enableHighAccuracy: true }
      );
    } else {
      const storedLocation = getStoredLocation();
      initializeMap(storedLocation.lat, storedLocation.lng);
    }



  </script>

</body>

</html>