<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카카오맵 북마크 시스템</title>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 70%;
      height: 100%;
      float: left;
    }

    #controls {
      width: 30%;
      height: 100%;
      float: left;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f9f9f9;
      border-left: 1px solid #ccc;
    }

    .bookmark-item {
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    .bookmark-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
    }

    button {
      margin: 3px 0;
      padding: 5px 10px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="controls">
    <h3>북마크 목록</h3>
    <div id="bookmarkList"></div>
    <hr>
    <button id="setStartCurrent">현재위치를 출발지로</button>
    <button id="setDestCurrent">현재위치를 도착지로</button>
  </div>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY&libraries=clusterer"></script>
  <script>
    var map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(36.3275, 127.4268), level: 5 });
    var bookmarks = [];
    var userPosition = null;

    function fetchBookmarks() {
      fetch('/api/subAchivment')
        .then(response => response.json())
        .then(data => {
          bookmarks = data;
          updateBookmarks();
        });
    }

    function updateBookmarks() {
      var bookmarkListDiv = document.getElementById('bookmarkList');
      bookmarkListDiv.innerHTML = '';
      bookmarks.forEach(bookmark => {
        var div = document.createElement('div');
        div.className = 'bookmark-item';
        div.innerHTML = `<img src="${bookmark.image}" class="bookmark-img"><br>
                         <strong>${bookmark.name}</strong><br>
                         위도: ${bookmark.lat}, 경도: ${bookmark.lng}<br>
                         <button onclick="setAsDest(${bookmark.lat}, ${bookmark.lng})">도착지로 지정</button>`;
        bookmarkListDiv.appendChild(div);
        addBookmarkToMap(bookmark);
      });
    }

    function addBookmarkToMap(bookmark) {
      if (!userPosition || getDistance(userPosition.lat, userPosition.lng, bookmark.lat, bookmark.lng) > 500) return;
      var marker = new kakao.maps.Marker({ position: new kakao.maps.LatLng(bookmark.lat, bookmark.lng), map: map });
    }

    function setAsDest(lat, lng) {
      var destPos = new kakao.maps.LatLng(lat, lng);
      map.setCenter(destPos);
      checkArrival(destPos);
    }

    function checkArrival(pos) {
      bookmarks.forEach(bookmark => {
        if (getDistance(pos.getLat(), pos.getLng(), bookmark.lat, bookmark.lng) < 50) {
          alert(bookmark.name + " 위치에 도착했습니다!");
          fetch('/api/achivmentC', { method: 'POST', body: JSON.stringify({ bookmarkId: bookmark.id }) });
        }
      });
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      function toRad(degree) { return degree * Math.PI / 180; }
      var R = 6371e3;
      var φ1 = toRad(lat1), φ2 = toRad(lat2);
      var Δφ = toRad(lat2 - lat1), Δλ = toRad(lng2 - lng1);
      var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(position => {
          userPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
          fetchBookmarks();
        });
      }
    }

    getUserLocation();
  </script>
</body>

</html>