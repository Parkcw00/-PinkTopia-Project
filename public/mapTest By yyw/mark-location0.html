<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>핑크군단 API - 확장 기능 예제</title>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      width: 70%;
      height: 100%;
      float: left;
    }

    #controls {
      width: 30%;
      height: 100%;
      float: left;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f9f9f9;
      border-left: 1px solid #ccc;
    }

    .bookmark-item {
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }

    button {
      margin: 3px 0;
      padding: 5px 10px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="controls">
    <h3>북마크 목록</h3>
    <div id="bookmarkList"></div>
    <hr>
    <button id="setStartCurrent">현재위치를 출발지로</button>
    <button id="setDestCurrent">현재위치를 도착지로</button>
    <button id="openKakaoMap">카카오맵 열기</button>
  </div>

  <!-- 카카오맵 SDK (자신의 appkey로 변경) -->
  <script
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5dc1bc6ffb574e60204390643bad8557&libraries=clusterer"></script>
  <script>
    // 지도 초기화
    var mapContainer = document.getElementById('map'),
      mapOption = {
        center: new kakao.maps.LatLng(36.3275, 127.4268),
        level: 5,
        mapTypeId: kakao.maps.MapTypeId.ROADMAP
      };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var zoomControl = new kakao.maps.ZoomControl();
    map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

    // 출발지, 도착지 마커 생성 (드래그 가능)
    var startMarker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(36.3275, 127.4268),
      draggable: true
    });
    startMarker.setMap(map);

    var destMarker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(36.3335, 127.4268),
      draggable: true
    });
    destMarker.setMap(map);

    // 인포윈도우 생성 (초기 내용 포함)
    var startInfowindow = new kakao.maps.InfoWindow({
      content: '<div style="padding:5px;">출발지<br><a href="https://map.kakao.com/link/to/출발지,36.3275,127.4268" target="_blank" style="color:blue;">길찾기</a></div>'
    });
    var destInfowindow = new kakao.maps.InfoWindow({
      content: '<div style="padding:5px;">도착지<br><a href="https://map.kakao.com/link/to/도착지,36.3335,127.4268" target="_blank" style="color:blue;">길찾기</a></div>'
    });

    // 마커에 마우스 이벤트 등록
    kakao.maps.event.addListener(startMarker, 'mouseover', function () {
      startInfowindow.open(map, startMarker);
    });
    kakao.maps.event.addListener(startMarker, 'mouseout', function () {
      startInfowindow.close();
    });
    kakao.maps.event.addListener(destMarker, 'mouseover', function () {
      destInfowindow.open(map, destMarker);
    });
    kakao.maps.event.addListener(destMarker, 'mouseout', function () {
      destInfowindow.close();
    });

    // 도착지 마커 이동 시 인포윈도우 링크 업데이트 및 도착 체크
    kakao.maps.event.addListener(destMarker, 'dragend', function () {
      var pos = destMarker.getPosition();
      var content = '<div style="padding:5px;">도착지<br>' +
        '<a href="https://map.kakao.com/link/to/도착지,' + pos.getLat() + ',' + pos.getLng() + '" target="_blank" style="color:blue;">길찾기</a></div>';
      destInfowindow.setContent(content);
      checkArrival(pos);
    });

    // 출발지 마커 이동 시 인포윈도우 업데이트
    kakao.maps.event.addListener(startMarker, 'dragend', function () {
      var pos = startMarker.getPosition();
      var content = '<div style="padding:5px;">출발지<br>' +
        '<a href="https://map.kakao.com/link/to/출발지,' + pos.getLat() + ',' + pos.getLng() + '" target="_blank" style="color:blue;">길찾기</a></div>';
      startInfowindow.setContent(content);
    });

    // 북마크 데이터 (DB 서브업적 테이블 데이터를 시뮬레이션)
    var bookmarks = [
      { id: 1, name: '북마크1', lat: 36.3305, lng: 127.4268 },
      { id: 2, name: '북마크2', lat: 36.3350, lng: 127.4300 },
      { id: 3, name: '북마크3', lat: 36.3400, lng: 127.4400 }
    ];

    // 북마크 목록 출력
    var bookmarkListDiv = document.getElementById('bookmarkList');
    bookmarks.forEach(function (bookmark) {
      var div = document.createElement('div');
      div.className = 'bookmark-item';
      div.innerHTML = '<strong>' + bookmark.name + '</strong><br>' +
        '위도: ' + bookmark.lat + ', 경도: ' + bookmark.lng + '<br>' +
        '<button onclick="setAsStart(' + bookmark.lat + ',' + bookmark.lng + ')">출발지로 지정</button> ' +
        '<button onclick="setAsDest(' + bookmark.lat + ',' + bookmark.lng + ')">도착지로 지정</button>';
      bookmarkListDiv.appendChild(div);
    });

    // 북마크 선택 시 마커 위치 변경 함수
    function setAsStart(lat, lng) {
      var newPos = new kakao.maps.LatLng(lat, lng);
      startMarker.setPosition(newPos);
      map.setCenter(newPos);
    }
    function setAsDest(lat, lng) {
      var newPos = new kakao.maps.LatLng(lat, lng);
      destMarker.setPosition(newPos);
      map.setCenter(newPos);
      checkArrival(newPos);
    }

    // 현재 위치를 출발지/도착지로 설정하는 기능
    document.getElementById('setStartCurrent').addEventListener('click', function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var newPos = new kakao.maps.LatLng(lat, lng);
          startMarker.setPosition(newPos);
          map.setCenter(newPos);
        });
      } else {
        alert('이 브라우저에서는 Geolocation을 지원하지 않습니다.');
      }
    });
    document.getElementById('setDestCurrent').addEventListener('click', function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var newPos = new kakao.maps.LatLng(lat, lng);
          destMarker.setPosition(newPos);
          map.setCenter(newPos);
          checkArrival(newPos);
        });
      } else {
        alert('이 브라우저에서는 Geolocation을 지원하지 않습니다.');
      }
    });

    // 카카오맵 열기 버튼: 현재 설정된 출발지와 도착지를 기준으로 길찾기 링크 오픈
    document.getElementById('openKakaoMap').addEventListener('click', function () {
      var startPos = startMarker.getPosition();
      var destPos = destMarker.getPosition();
      // 예시 URL: 필요에 따라 URL 형식을 조정하세요.
      var url = "https://map.kakao.com/link/to/길찾기,";
      url += startPos.getLat() + "," + startPos.getLng() + "/";
      url += destPos.getLat() + "," + destPos.getLng();
      window.open(url, '_blank');
    });

    // 두 좌표 간의 거리를 계산하는 함수 (Haversine 공식)
    function getDistance(lat1, lng1, lat2, lng2) {
      function toRad(degree) {
        return degree * Math.PI / 180;
      }
      var R = 6371e3; // 지구 반지름 (m)
      var φ1 = toRad(lat1);
      var φ2 = toRad(lat2);
      var Δφ = toRad(lat2 - lat1);
      var Δλ = toRad(lng2 - lng1);
      var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 도착지 마커가 북마크 위치에 근접(50m 이내)하면 알람 표시
    function checkArrival(pos) {
      bookmarks.forEach(function (bookmark) {
        var distance = getDistance(pos.getLat(), pos.getLng(), bookmark.lat, bookmark.lng);
        if (distance < 50) {
          alert(bookmark.name + " 위치에 도착했습니다!");
        }
      });
    }

    // 북마크 관련 함수들을 전역 노출
    window.setAsStart = setAsStart;
    window.setAsDest = setAsDest;
  </script>
</body>

</html>