<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì±„íŒ…ë°© ëª©ë¡</title>
    <link rel="stylesheet" href="/public/styles.css" />
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê°œì„  */
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        font-size: 16px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 15px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 15px;
      }
      
      /* ì±„íŒ…ë°© ì¹´ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
      .room-item {
        padding: 12px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .room-item h3 {
        font-size: 18px;
        margin: 0 0 8px 0;
        word-break: break-word;
      }
      
      .room-item p {
        font-size: 14px;
        margin: 0 0 8px 0;
        color: #666;
      }

      /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê°œì„  */
      .button {
        padding: 8px 15px;
        background-color: #ff69b4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 5px;
        white-space: nowrap;
      }

      /* ì±„íŒ…ë°© ì…ì¥ í¼ ê°œì„  */
      .join-room-form {
        margin-bottom: 15px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .join-room-form input {
        flex: 1;
        min-width: 200px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      /* ì±„íŒ…ë°© ë‚´ë¶€ ë²„íŠ¼ ì •ë¦¬ */
      .room-actions {
        margin-top: 8px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* ëª¨ë°”ì¼ í™”ë©´ ëŒ€ì‘ ì¶”ê°€ */
      @media (max-width: 480px) {
        .container {
          padding: 10px;
        }
        
        h1 {
          font-size: 20px;
        }
        
        .button {
          padding: 10px 12px;
          font-size: 14px;
          flex-grow: 1;
          text-align: center;
          min-width: 70px;
        }
        
        .room-item {
          padding: 10px;
        }
        
        .room-item h3 {
          font-size: 16px;
        }
        
        .room-actions {
          justify-content: space-between;
        }
        
        .join-room-form {
          flex-direction: column;
        }
        
        .join-room-form input {
          width: 100%;
          min-width: unset;
        }
        
        .create-room {
          margin-bottom: 15px;
        }
        
        .create-room .button {
          width: 100%;
        }
        
        .modal-content {
          width: 90%;
          margin: 30% auto;
          padding: 15px;
        }
      }
      
      /* ë” ì‘ì€ ëª¨ë°”ì¼ í™”ë©´ìš© */
      @media (max-width: 360px) {
        .room-actions {
          flex-direction: column;
        }
        
        .button {
          width: 100%;
        }
        
        .nav {
          padding: 10px;
          height: 40px;
        }
        
        .logo-text {
          font-size: 18px;
        }
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .room-list {
        margin-top: 20px;
      }

      /* ì±„íŒ…ë°© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .room-item {
        padding: 15px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      /* ì±„íŒ…ë°© í˜¸ë²„ ìƒ‰ìƒ ë³€ê²½ */
      .room-item:hover {
        background-color: #fff0f7;
      }

      /* ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
      .button {
        padding: 10px 20px;
        background-color: #ff69b4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      /* ë²„íŠ¼ hover ìƒ‰ìƒ */
      .button:hover {
        background-color: #ff4da6;
      }

      /* ì±„íŒ…ë°© ì´ˆëŒ€ ì…ë ¥ í¼ */
      .join-room-form {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      .join-room-form input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      /* ì±„íŒ…ë°© ì…ì¥ ë²„íŠ¼ */
      .join-room-form button {
        background-color: #ff85c0;
      }

      .join-room-form button:hover {
        background-color: #ff4da6;
      }

      /* ì±„íŒ…ë°© ë‚˜ê°€ê¸° ë²„íŠ¼ */
      .leave-btn {
        background-color: #ff6b6b;
      }

      .leave-btn:hover {
        background-color: #ff3b3b;
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .modal-header {
        margin-bottom: 20px;
      }

      .modal-header h2 {
        margin: 0;
        color: #333;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-body input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      /* ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ */
      .close {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }

      .close:hover {
        color: #000;
      }

      /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ff69b4;
        padding: 15px;
        color: white;
        font-weight: bold;
        position: relative;
        height: 50px;
      }

      /* í–„ë²„ê±° ë©”ë‰´ */
      .menu-icon {
        position: absolute;
        left: 15px;
        height: 100%;
        display: flex;
        align-items: center;
        cursor: pointer;
        z-index: 2;
      }

      .menu-icon .hamburger {
        width: 25px;
        height: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .menu-icon .hamburger span {
        display: block;
        height: 3px;
        width: 100%;
        background-color: white;
        border-radius: 3px;
        transition: all 0.3s ease;
      }

      /* ë¡œê³  ì»¨í…Œì´ë„ˆ */
      .nav .logo-container {
        position: absolute;
        left: 50px;
        height: 100%;
        display: flex;
        align-items: center;
      }

      .nav img {
        width: 45px;
        height: 45px;
        border-radius: 0;
        object-fit: cover;
      }

      /* ë¡œê³  í…ìŠ¤íŠ¸ */
      .nav .logo-text {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 24px;
      }

      /* ì‚¬ì´ë“œë°” */
      .sidebar {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        background-color: #ff69b4;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
        box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
      }

      .sidebar a {
        padding: 15px 25px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: block;
        transition: 0.3s;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar a:hover {
        background-color: #ff4da6;
      }

      /* ì‚¬ì´ë“œë°” ë‹«ê¸° ë²„íŠ¼ */
      .close-sidebar {
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 36px;
        cursor: pointer;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="nav">
      <div class="menu-icon" onclick="openSidebar()">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="logo-container">
        <img src="/public/images/123.jpg" alt="PinkTopia Logo" />
      </div>
      <div class="logo-text">
        <a href="/public/home.html" style="text-decoration: none; color: white"
          >PinkTopia</a
        >
      </div>
    </div>

    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <span class="close-sidebar" onclick="closeSidebar()">&times;</span>
      </div>
      <div class="sidebar-content">
        <a href="/public/home.html">í™ˆ</a>
        <a href="/public/event.html">ì´ë²¤íŠ¸</a>
        <a href="/public/store-item.html">ì•„ì´í…œìƒµ</a>
        <a href="/public/board.html">ê²Œì‹œê¸€ (ì»¤ë®¤ë‹ˆí‹°)</a>
        <a href="/public/ranking.html">ë­í‚¹</a>
        <!-- ë¡œê·¸ì¸ ì‹œ í‘œì‹œë  ë©”ë‰´ë“¤ -->
        <div id="loggedInMenu" style="display: none">
          <a href="/public/chattingrooms.html">ì±„íŒ…</a>
          <a href="/public/collection.html">í•‘í¬ëª½ ê°œì¸ ë„ê°</a>
          <a href="/public/inventory.html">ì¸ë²¤í† ë¦¬ ì•„ì´í…œ</a>
          <a href="/public/achievements.html">ì—…ì </a>
          <a href="/public/mypage.html">ë§ˆì´í˜ì´ì§€</a>
          <a href="/public/customer-service.html">ê³ ê° ì„¼í„°</a>
          <a href="#" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
        <!-- ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° í‘œì‹œë  ë©”ë‰´ë“¤ -->
        <div id="loggedOutMenu">
          <a href="/public/log-in.html">ë¡œê·¸ì¸</a>
          <a href="/public/sign-up.html">íšŒì›ê°€ì…</a>
        </div>
      </div>
    </div>

    <div class="container">
      <h1>ì±„íŒ…ë°© ëª©ë¡</h1>

      <script>
        let socket; // ì „ì—­ socket ë³€ìˆ˜ ì„ ì–¸
      </script>

      <!-- ì±„íŒ…ë°© ì§ì ‘ ì…ì¥ í¼ ì¶”ê°€ -->
      <div class="join-room-form">
        <input type="text" id="roomInput" placeholder="ì´ˆëŒ€ ë§í¬ ì…ë ¥" />
        <button class="button" onclick="joinDirectRoom()">ì±„íŒ…ë°© ì…ì¥</button>
      </div>

      <div class="create-room">
        <button class="button" onclick="createRoom()">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
      </div>

      <div class="room-list" id="roomList">
        <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
      </div>
    </div>

    <!-- ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="createRoomModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">
          <h2>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h2>
        </div>
        <div class="modal-body">
          <input
            type="text"
            id="roomTitle"
            placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
          />
        </div>
        <div class="modal-footer">
          <button class="button" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="button" onclick="createRoomWithTitle()">ìƒì„±</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          window.location.href = '/';
          return;
        }

        try {
          // ì±„íŒ…ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const response = await fetch('/chattingroom', {
            headers: {
              Authorization: localStorage.getItem('accessToken'),
            },
          });

          if (!response.ok) {
            throw new Error('ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const data = await response.json();
          console.log('ì±„íŒ…ë°© ëª©ë¡:', data);

          // ì±„íŒ…ë°© ëª©ë¡ í‘œì‹œ
          if (data.chattingRooms && Array.isArray(data.chattingRooms)) {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
            data.chattingRooms.forEach((room) => {
              addRoomToList(room);
            });
          }
        } catch (error) {
          console.error('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert(error.message || 'ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });

      async function createRoom() {
        showModal();
      }

      // ì±„íŒ…ë°© ì…ì¥ í•¨ìˆ˜ ìˆ˜ì •
      async function joinRoom(roomId) {
        try {
          // ë¨¼ì € ì±„íŒ…ë°© ë©¤ë²„ì¸ì§€ í™•ì¸
          const checkResponse = await fetch(`/chatmember/check/${roomId}`, {
            headers: {
              Authorization: localStorage.getItem('accessToken'),
            },
          });

          if (!checkResponse.ok) {
            throw new Error(
              'ì±„íŒ…ë°© ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤. ì´ˆëŒ€ ë§í¬ë¥¼ í†µí•´ì„œë§Œ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            );
          }

          // ë©¤ë²„ì¸ ê²½ìš°ì—ë§Œ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
          window.location.href = `/public/chatting.html?roomId=${roomId}`;
        } catch (error) {
          console.error('ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨:', error);
          alert(error.message || 'ì±„íŒ…ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì±„íŒ…ë°© ì…ì¥ í•¨ìˆ˜ ìˆ˜ì •
      async function joinDirectRoom() {
        const input = document.getElementById('roomInput').value.trim();
        if (!input) {
          alert('ì´ˆëŒ€ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          let roomId;

          // URLì—ì„œ roomId ì¶”ì¶œ (ë‘ ê°€ì§€ í˜•ì‹ ëª¨ë‘ ì§€ì›)
          if (input.includes('/chattingroom/')) {
            // /chattingroom/{id}/join í˜•ì‹
            const urlParts = input.split('/');
            roomId = urlParts[urlParts.indexOf('chattingroom') + 1];
          } else if (input.includes('/invite.html?roomId=')) {
            // /invite.html?roomId={id} í˜•ì‹
            const urlParams = new URLSearchParams(input.split('?')[1]);
            roomId = urlParams.get('roomId');
          } else {
            throw new Error('ì˜¬ë°”ë¥¸ ì´ˆëŒ€ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          }

          if (!roomId || isNaN(roomId)) {
            throw new Error('ì˜¬ë°”ë¥¸ ì´ˆëŒ€ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          }

          // ì±„íŒ…ë°© ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const checkResponse = await fetch(`/chattingroom/${roomId}`, {
            headers: {
              Authorization: localStorage.getItem('accessToken'),
            },
          });

          if (!checkResponse.ok) {
            throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì±„íŒ…ë°©ì…ë‹ˆë‹¤.');
          }

          // ì±„íŒ…ë°© ë©¤ë²„ í™•ì¸ ë° ê°€ì… ì²˜ë¦¬
          const memberCheckResponse = await fetch(
            `/chatmember/check/${roomId}`,
            {
              headers: {
                Authorization: localStorage.getItem('accessToken'),
              },
            },
          );

          if (!memberCheckResponse.ok) {
            // ë©¤ë²„ê°€ ì•„ë‹ˆë¼ë©´ ìƒˆë¡œ ê°€ì…
            const joinResponse = await fetch(`/chatmember`, {
              method: 'POST',
              headers: {
                Authorization: localStorage.getItem('accessToken'),
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                chatting_room_id: parseInt(roomId),
              }),
            });

            if (!joinResponse.ok) {
              const errorData = await joinResponse.json();
              throw new Error(
                errorData.message || 'ì±„íŒ…ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
              );
            }
          }

          // ë©¤ë²„ í™•ì¸ ë˜ëŠ” ìƒì„±ì´ ì„±ê³µí•˜ë©´ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
          window.location.href = `/public/chatting.html?roomId=${roomId}`;
        } catch (error) {
          console.error('ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨:', error);
          alert(error.message || 'ì±„íŒ…ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì´ˆëŒ€ ë§í¬ ìƒì„± ë° ê³µìœ  ë²„íŠ¼ ì¶”ê°€
      function addRoomToList(room) {
        const roomElement = document.createElement('div');
        roomElement.className = 'room-item';
        roomElement.innerHTML = `
                <h3>${room.title || 'ì±„íŒ…ë°© ' + room.id}</h3>
                <p>ì°¸ì—¬ì: ${room.members}</p>
                <div class="room-actions">
                    <button onclick="joinRoom(${room.id})" class="button">ì…ì¥</button>
                    <button onclick="shareInviteLink(${room.id})" class="button share-btn">ì´ˆëŒ€ ë§í¬ ê³µìœ </button>
                    <button onclick="leaveRoom(${room.id})" class="button leave-btn">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
                </div>
            `;
        document.getElementById('roomList').appendChild(roomElement);
      }

      // ì´ˆëŒ€ ë§í¬ ê³µìœ  í•¨ìˆ˜
      async function shareInviteLink(roomId) {
        try {
          const inviteLink = `/public/chattingroom/${roomId}/join`;
          const fullLink = window.location.origin + inviteLink;

          await navigator.clipboard.writeText(fullLink);
          alert('ì´ˆëŒ€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n' + fullLink);

          // ë‹‰ë„¤ì„ìœ¼ë¡œ ì´ˆëŒ€í•˜ê¸°
          const nickname = prompt('ì´ˆëŒ€í•  ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:');
          if (nickname) {
            const response = await fetch(`/chattingroom/${roomId}/send-url`, {
              method: 'POST',
              headers: {
                Authorization: localStorage.getItem('accessToken'),
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                nickname: nickname,
              }),
            });

            if (response.ok) {
              alert('ì´ˆëŒ€ ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
              const error = await response.json();
              throw new Error(error.message);
            }
          }
        } catch (error) {
          console.error('ì´ˆëŒ€ ë§í¬ ê³µìœ  ì‹¤íŒ¨:', error);
          alert(error.message || 'ì´ˆëŒ€ ë§í¬ ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ë‹¤ë¥¸ í˜ì´ì§€ ì´ë™ URLë“¤ë„ ìˆ˜ì •
      function redirectToLogin() {
        window.location.href = '/';
      }

      // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€
      function showModal() {
        document.getElementById('createRoomModal').style.display = 'block';
      }

      function closeModal() {
        document.getElementById('createRoomModal').style.display = 'none';
      }

      // ì‹¤ì œ ì±„íŒ…ë°© ìƒì„± í•¨ìˆ˜
      async function createRoomWithTitle() {
        const title = document.getElementById('roomTitle').value.trim();

        if (!title) {
          alert('ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        try {
          // ì±„íŒ…ë°© ìƒì„±
          const response = await fetch('/chattingroom', {
            method: 'POST',
            headers: {
              Authorization: localStorage.getItem('accessToken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ title }),
          });

          if (!response.ok) {
            throw new Error('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');
          }

          // ì‘ë‹µì—ì„œ ì±„íŒ…ë°© ID ì¶”ì¶œ
          const result = await response.json();
          console.log('ì±„íŒ…ë°© ìƒì„± ì‘ë‹µ:', result);

          if (!result.id) {
            throw new Error('ì±„íŒ…ë°© IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

          // ëª¨ë‹¬ ë‹«ê³  ìƒì„±ëœ ì±„íŒ…ë°©ìœ¼ë¡œ ë°”ë¡œ ì…ì¥
          closeModal();
          window.location.href = `/public/chatting.html?roomId=${result.id}`;
        } catch (error) {
          console.error('ì±„íŒ…ë°© ìƒì„±/ì…ì¥ ì‹¤íŒ¨:', error);
          alert(error.message || 'ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      window.addEventListener('click', (e) => {
        if (e.target === document.getElementById('createRoomModal')) {
          closeModal();
        }
      });

      // ì±„íŒ…ë°© ì™„ì „íˆ ë‚˜ê°€ê¸° í•¨ìˆ˜ (ë©¤ë²„ ì‚­ì œ)
      async function leaveRoom(roomId) {
        if (
          !confirm(
            'ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì—ì„œ ì™„ì „íˆ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\në‚˜ê°€ê¸°ë¥¼ í•˜ë©´ ë‹¤ì‹œ ì´ˆëŒ€ë¥¼ ë°›ì•„ì•¼ ì…ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
          )
        ) {
          return;
        }

        try {
          // ë¨¼ì € ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const memberResponse = await fetch(`/chatmember/check/${roomId}`, {
            headers: {
              Authorization: localStorage.getItem('accessToken'),
            },
          });

          if (!memberResponse.ok) {
            throw new Error('ì±„íŒ…ë°© ë©¤ë²„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const memberData = await memberResponse.json();
          const userId = memberData.user_id;
          const nickname = memberData.user.nickname;

          // ì†Œì¼“ ì—°ê²°
          const socket = io('/chatmember', {
            withCredentials: true,
            auth: {
              token: localStorage.getItem('accessToken'),
            },
          });

          // í‡´ì¥ ì´ë²¤íŠ¸ ë°œìƒ
          socket.emit('permanentLeaveChatRoom', {
            userId: userId,
            roomId: roomId,
            nickname: nickname,
          });

          const response = await fetch(
            `/chatmember/permanent-leave/${roomId}`,
            {
              method: 'DELETE',
              headers: {
                Authorization: localStorage.getItem('accessToken'),
              },
            },
          );

          if (!response.ok) {
            throw new Error('ì±„íŒ…ë°© ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          // ì†Œì¼“ ì—°ê²° í•´ì œ
          socket.disconnect();

          // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
          window.location.reload();
        } catch (error) {
          console.error('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨:', error);
          alert(error.message || 'ì±„íŒ…ë°© ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      function openSidebar() {
        document.getElementById('sidebar').style.width = '250px';
      }

      function closeSidebar() {
        document.getElementById('sidebar').style.width = '0';
      }

      document.addEventListener('DOMContentLoaded', function () {
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
          document.getElementById('loggedInMenu').style.display = 'block';
          document.getElementById('loggedOutMenu').style.display = 'none';
        } else {
          document.getElementById('loggedInMenu').style.display = 'none';
          document.getElementById('loggedOutMenu').style.display = 'block';
        }
      });

      async function logout() {
        try {
          const accessToken = localStorage.getItem('accessToken');
          if (!accessToken) {
            console.warn('ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹œë„: ì´ë¯¸ ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœ');
            window.location.href = '/public/log-in.html';
            return;
          }

          // ğŸ”¹ ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ë³´ë‚´ê¸°
          const response = await fetch('/user/auth/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: accessToken,
            },
            credentials: 'include', // ì¿ í‚¤ë„ í•¨ê»˜ ë³´ë‚´ê¸°
          });

          if (!response.ok) {
            throw new Error('ì„œë²„ì—ì„œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨');
          }

          // âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„, í† í° ì‚­ì œ
          localStorage.removeItem('accessToken');

          console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì„±ê³µ! í˜ì´ì§€ ì´ë™');
          window.location.href = '/'; //
        } catch (error) {
          console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
          alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
    </script>
  </body>
</html>
