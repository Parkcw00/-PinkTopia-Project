<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>채팅방</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .chat-title {
        font-size: 24px;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
      }

      .chat-box {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 8px;
      }

      .message {
        margin-bottom: 10px;
        clear: both;
      }

      .message-content {
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 70%;
        display: inline-block;
      }

      .my-message {
        float: right;
      }

      .my-message .message-content {
        background-color: #dcf8c6;
      }

      .message:not(.my-message) .message-content {
        background-color: white;
        float: left;
      }

      .nickname {
        font-size: 0.8em;
        color: #666;
        display: block;
        margin-bottom: 4px;
      }

      .timestamp {
        font-size: 0.7em;
        color: #999;
        margin-left: 8px;
      }

      .system {
        text-align: center;
      }

      .system .message-content {
        background: none;
        color: #666;
        font-style: italic;
      }

      .input-area {
        display: flex;
        gap: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .input-area input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .button:hover {
        background-color: #45a049;
      }

      /* 메시지 컨테이너 clear fix */
      .chat-box::after {
        content: '';
        display: table;
        clear: both;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-title">채팅방</div>
      <div id="chatBox" class="chat-box"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요" onkeypress="handleKeyPress(event)">
        <input type="file" id="fileInput" style="display: none;" onchange="uploadFile(event)">
        <button class="button" onclick="sendMessage()">전송</button>
        <button class="button" onclick="document.getElementById('fileInput').click()">파일 업로드</button>
        <button class="button" onclick="leaveRoom()">나가기</button>
      </div>
    </div>

    <script>
      let socket;
      let currentRoomId;
      let currentUserId; // 현재 사용자 ID 변수 추가
      let currentUserNickname; // 현재 사용자 닉네임 변수 추가
      
      // 페이지 로드 시 인증 확인
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        currentRoomId = roomId;
        
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            window.location.href = '/public/login.html';
            return;
        }

        try {
            // 채팅 멤버 확인 (한 번만 요청)
            const memberResponse = await fetch(`http://localhost:3000/chatmember/check/${roomId}`, {
                headers: {
                    'Authorization': accessToken
                }
            });
            
            if (!memberResponse.ok) {
                console.log('멤버가 아님, 입장 불가');
                alert('채팅방 멤버가 아닙니다. 입장할 수 없습니다.');
                window.location.href = '/public/chattingrooms.html';
                return;
            }

            const data = await memberResponse.json();
            console.log('멤버 정보 데이터:', data);

            if (data && data.user_id) {
                currentUserId = data.user_id;
                currentUserNickname = data.user.nickname;
                console.log('현재 사용자 ID:', currentUserId);
                console.log('현재 사용자 닉네임:', currentUserNickname);

                // socket.io 연결 설정
                socket = io('http://localhost:3000/chatting', {
                    withCredentials: true,
                    auth: {
                        token: accessToken
                    }
                });

                // 소켓 연결 후 방 입장
                socket.emit('joinRoom', { roomId: parseInt(roomId) });

                // 소켓 이벤트 리스너 설정
                setupSocketListeners();
                initializeChatRoom(roomId);
            } else {
                throw new Error('채팅방 멤버 정보를 가져올 수 없습니다.');
            }
        } catch (error) {
            console.error('채팅방 입장 실패:', error);
            alert(error.message || '채팅방 입장에 실패했습니다.');
            window.location.href = '/public/chattingrooms.html';
        }
      });

      function setupSocketListeners() {
        socket.on('connect', () => {
          console.log('소켓 연결됨:', socket.id);
          addSystemMessage('채팅방에 연결되었습니다.');
        });

        socket.on('message', (data) => {
          console.log('메시지 수신:', data);  // 디버깅용
          
          const chatBox = document.getElementById('chatBox');
          const messageDiv = document.createElement('div');
          
          // 시스템 메시지인 경우
          if (data.type === 'system') {
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
              <div class="message-content">
                <span class="message-text">${data.message}</span>
                <span class="timestamp">${new Date(data.timestamp).toLocaleTimeString()}</span>
              </div>
            `;
          } else {
            // 일반 메시지 처리
            const isMyMessage = data.userId === currentUserId;
            messageDiv.className = `message ${isMyMessage ? 'my-message' : ''}`;
            
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            if (isMyMessage) {
              messageDiv.innerHTML = `
                <div class="message-content">
                  <span class="message-text">${data.message}</span>
                  <span class="timestamp">${timestamp}</span>
                </div>
              `;
            } else {
              messageDiv.innerHTML = `
                <div class="message-content">
                  <div class="nickname">${data.nickname}</div>
                  <span class="message-text">${data.message}</span>
                  <span class="timestamp">${timestamp}</span>
                </div>
              `;
            }
          }
          
          chatBox.appendChild(messageDiv);
          chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('error', (error) => {
          console.error('소켓 에러:', error);
          addSystemMessage('오류가 발생했습니다.');
        });

        // 멤버가 완전히 나갔을 때의 이벤트 리스너 추가
        socket.on('memberLeft', (data) => {
          console.log('멤버 퇴장:', data);
          // 시스템 메시지로 표시
          addSystemMessage(data.message);
        });
      }

      // 메시지 전송 함수
      async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message && socket && currentRoomId) {
            try {
                socket.emit('sendMessage', {
                    roomId: currentRoomId,
                    message: message
                });
                
                // 입력창 초기화
                messageInput.value = '';
            } catch (error) {
                console.error('메시지 전송 실패:', error);
                alert('메시지 전송에 실패했습니다.');
            }
        }
      }

      // 채팅방 임시 나가기 함수
      async function leaveRoom() {
        if (!confirm('정말로 채팅방을 나가시겠습니까?')) {
            return;
        }

        try {
            if (socket) {
                socket.emit('temporaryLeaveChatRoom', {
                    userId: currentUserId,
                    roomId: currentRoomId,
                    nickname: currentUserNickname
                });
                socket.disconnect();
            }
            window.location.href = '/public/chattingrooms.html';
        } catch (error) {
            console.error('채팅방 나가기 실패:', error);
            alert(error.message || '채팅방 나가기에 실패했습니다.');
        }
      }

      // Enter 키로 메시지 전송
      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      // 시스템 메시지 추가
      function addSystemMessage(message) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system';
        messageDiv.innerHTML = `
            <div class="message-content">
                <span class="message-text">${message}</span>
                <span class="timestamp">${new Date().toLocaleTimeString()}</span>
            </div>
        `;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // 채팅방 UI 초기화 함수 수정 - 소켓 이벤트 리스너 설정 제거
      function initializeChatRoom(roomId) {
        // 채팅방 제목과 멤버 정보 설정만 수행
        const chatTitle = document.querySelector('.chat-title');
        chatTitle.textContent = `채팅방 ${roomId}`;
      }

      // 멤버 목록 업데이트 함수
      function updateMemberList(members) {
        const memberList = document.querySelector('.member-list ul');
        if (memberList) {
          memberList.innerHTML = members.map(member => `
            <li>${member.nickname}</li>
          `).join('');
        }
      }

      // 파일 업로드 함수
async function uploadFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  // 클라이언트 측에서 파일 형식 검증
  if (!file.type.startsWith('image/')) {
    alert('이미지 파일만 업로드할 수 있습니다.');
    return;
  }

  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch(`http://localhost:3000/chattingroom/${currentRoomId}/upload`, {
      method: 'POST',
      headers: {
        'Authorization': `${localStorage.getItem('accessToken')}`
      },
      body: formData
    });

    if (response.ok) {
      const data = await response.json();
      console.log('파일 업로드 성공:', data);
      
      // 파일 업로드 성공 시 소켓 이벤트 발생
      socket.emit('fileUploaded', {
        roomId: parseInt(currentRoomId),
        fileUrl: data.message
      });
    } else {
      const error = await response.json();
      throw new Error(error.message || '파일 업로드에 실패했습니다.');
    }
  } catch (error) {
    console.error('파일 업로드 실패:', error);
    alert(error.message || '파일 업로드에 실패했습니다.');
  }
}
    </script>
  </body>
</html>
