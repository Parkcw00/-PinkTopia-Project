<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>채팅</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .chat-box {
        height: 400px;
        border: 1px solid #ddd;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 20px;
      }
      .message {
        margin-bottom: 10px;
        padding: 5px;
      }
      .message.system {
        color: #666;
        font-style: italic;
      }
      .message .nickname {
        font-weight: bold;
        margin-right: 10px;
      }
      .message .timestamp {
        color: #999;
        font-size: 0.8em;
      }
      .input-area {
        display: flex;
        gap: 10px;
      }
      .input-area input {
        flex: 1;
        padding: 5px;
      }
      .button {
        padding: 8px 15px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="chat-title">채팅</h1>

      <!-- 채팅방 입장 섹션 - 숨김 처리 -->
      <div id="joinSection" style="display: none">
        <input type="number" id="userId" placeholder="사용자 ID" />
        <input type="number" id="roomId" placeholder="채팅방 ID" />
        <button class="button" onclick="joinRoom()">입장하기</button>
      </div>

      <!-- 채팅 섹션 - 기본적으로 표시 -->
      <div id="chatSection">
        <div id="chatBox" class="chat-box"></div>
        <div class="input-area">
          <input
            type="text"
            id="messageInput"
            placeholder="메시지를 입력하세요"
            onkeypress="handleKeyPress(event)"
          />
          <button class="button" onclick="sendMessage()">전송</button>
          <button
            class="button"
            onclick="leaveRoom()"
            style="background-color: #dc3545"
          >
            나가기
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentRoomId = null;
      let socket = null; // 전역 변수로 socket 선언
      
      // 페이지 로드 시 인증 확인
      window.addEventListener('load', () => {
        // URL에서 roomId 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        currentRoomId = roomId;  // roomId 저장
        
        // localStorage에서 인증 토큰 가져오기
        const accessToken = localStorage.getItem('accessToken');

        if (!accessToken) {
            window.location.href = 'login.html';
            return;
        }

        // socket 초기화
        socket = io('http://localhost:3000/chatting', {
            withCredentials: true,
            auth: {
                token: accessToken
            },
            extraHeaders: {
                'Authorization': `Bearer ${accessToken}`  // Authorization 헤더 추가
            }
        });

        // 소켓 이벤트 리스너 설정
        setupSocketListeners();

        // 채팅방 입장
        if (roomId) {
            // 먼저 채팅 멤버인지 확인
            fetch(`http://localhost:3000/chattingroom/${roomId}/chatmember`, {  // 엔드포인트 수정
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                console.log('채팅 멤버 확인 응답:', data);
                
                // 멤버인 경우에만 소켓 연결 시도
                if (!data.message || data.message !== '해당 채팅멤버가 존재하지 않습니다.') {
                    console.log('채팅 멤버 확인 완료:', data);
                    
                    // 멤버 확인 후 소켓 연결
                    socket.emit('joinRoom', { 
                        roomId,
                        token: accessToken
                    }, (response) => {
                        if (response.success) {
                            console.log(`채팅방 ${roomId}에 입장했습니다.`);
                            // 채팅방 정보 요청
                            socket.emit('getRoomInfo', { roomId }, (roomInfo) => {
                                if (roomInfo.success) {
                                    console.log('채팅방 정보:', roomInfo);
                                    initializeChatRoom(roomId, roomInfo.data);
                                }
                            });
                        } else {
                            console.error('채팅방 입장 실패:', response.message);
                            alert('채팅방 입장에 실패했습니다.');
                            window.location.href = 'login.html';
                        }
                    });
                } else {
                    console.error('채팅 멤버가 아닙니다.');
                    alert('해당 채팅방의 멤버가 아닙니다.');
                    window.location.href = 'login.html';
                }
            })
            .catch(error => {
                console.error('채팅 멤버 확인 실패:', error);
                alert('채팅 멤버 확인에 실패했습니다.');
                window.location.href = 'login.html';
            });
        }
      });

      function setupSocketListeners() {
        // 새 메시지 수신
        socket.on('newMessage', (data) => {
            console.log('새 메시지 수신:', data);
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <span class="nickname">${data.nickname || '익명'}</span>
                <span class="content">${data.message}</span>
                <span class="timestamp">${new Date().toLocaleTimeString()}</span>
            `;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // 사용자 입장/퇴장 메시지
        socket.on('userJoined', (data) => {
            addSystemMessage(`${data.nickname}님이 입장하셨습니다.`);
        });

        socket.on('userLeft', (data) => {
            addSystemMessage(`${data.nickname}님이 퇴장하셨습니다.`);
        });

        // 에러 처리
        socket.on('error', (error) => {
            console.error('Socket error:', error);
            alert(error.message || '오류가 발생했습니다.');
        });

        // 멤버 목록 업데이트
        socket.on('memberUpdate', (data) => {
            console.log('멤버 업데이트:', data);
            if (data.members) {
                updateMemberList(data.members);
            }
        });
    }

    // 메시지 전송 함수
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message && currentRoomId && socket) {
            console.log('메시지 전송:', { roomId: currentRoomId, message });
            socket.emit('sendMessage', {
                roomId: currentRoomId,
                message: message
            }, (response) => {
                if (response.success) {
                    messageInput.value = '';
                } else {
                    console.error('메시지 전송 실패:', response.message);
                }
            });
        }
    }

    // 채팅방 나가기 함수
    function leaveRoom() {
        if (currentRoomId && socket) {
            socket.emit('leaveRoom', { roomId: currentRoomId }, (response) => {
                if (response.success) {
                    window.location.href = 'login.html';
                } else {
                    console.error('채팅방 나가기 실패:', response.message);
                }
            });
        }
    }

    // Enter 키로 메시지 전송
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // 시스템 메시지 추가
    function addSystemMessage(message) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system';
        messageDiv.textContent = message;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 채팅방 UI 초기화 함수
    function initializeChatRoom(roomId, roomInfo) {
        // 채팅방 제목과 멤버 정보 설정
        const chatTitle = document.querySelector('.chat-title');
        chatTitle.textContent = `채팅방 ${roomId}`;
        
        // 멤버 목록 표시 영역 추가
        const memberList = document.createElement('div');
        memberList.className = 'member-list';
        memberList.innerHTML = `
            <h3>참여자 목록</h3>
            <ul>
                ${roomInfo.members.map(member => `
                    <li>${member.nickname}</li>
                `).join('')}
            </ul>
        `;
        document.querySelector('.container').insertBefore(memberList, document.querySelector('#chatSection'));

        // 스타일 추가
        const style = document.createElement('style');
        style.textContent = `
            .member-list {
                margin-bottom: 20px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 4px;
            }
            .member-list h3 {
                margin: 0 0 10px 0;
                color: #333;
            }
            .member-list ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .member-list li {
                padding: 5px 0;
            }
        `;
        document.head.appendChild(style);
    }

    // 멤버 목록 업데이트 함수
    function updateMemberList(members) {
        const memberList = document.querySelector('.member-list ul');
        if (memberList) {
            memberList.innerHTML = members.map(member => `
                <li>${member.nickname}</li>
            `).join('');
        }
    }
    </script>
  </body>
</html>
