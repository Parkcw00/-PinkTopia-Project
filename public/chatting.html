<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>채팅방</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }

      .chat-title {
        font-size: 24px;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
      }

      .chat-box {
        height: 500px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #fff;
      }

      .message {
        margin-bottom: 15px;
        max-width: 70%;
        clear: both;
      }

      .message-content {
        padding: 10px;
        border-radius: 15px;
        position: relative;
        display: inline-block;
      }

      /* 상대방 메시지 */
      .other-message {
        float: left;
      }

      .other-message .message-content {
        background-color: #f0f0f0;
        margin-left: 5px;
      }

      .other-message .nickname {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
        margin-left: 10px;
      }

      /* 내 메시지 */
      .my-message {
        float: right;
      }

      .my-message .message-content {
        background-color: #dcf8c6;
        margin-right: 5px;
      }

      /* 시스템 메시지 */
      .system {
        text-align: center;
        clear: both;
        margin: 10px 0;
        color: #666;
      }

      .system .message-content {
        background: none;
        font-style: italic;
        color: #666;
      }

      .timestamp {
        font-size: 0.7em;
        color: #999;
        margin-top: 5px;
        display: block;
      }

      .input-area {
        display: flex;
        gap: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      .input-area input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .button:hover {
        background-color: #45a049;
      }

      /* 메시지 컨테이너 clear fix */
      .chat-box::after {
        content: '';
        display: table;
        clear: both;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-title">채팅방</div>
      <div id="chatBox" class="chat-box"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요" onkeypress="handleKeyPress(event)">
        <button class="button" onclick="sendMessage()">전송</button>
        <button class="button" onclick="leaveRoom()">나가기</button>
      </div>
    </div>

    <script>
      let socket;
      let currentRoomId;
      let currentUserId; // 현재 사용자 ID 변수 추가
      
      // 페이지 로드 시 인증 확인
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        currentRoomId = roomId;
        
        // 토큰 확인
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            console.error('인증 토큰이 없습니다.');
            window.location.href = 'login.html';
            return;
        }

        // 채팅 멤버 확인
        fetch(`http://localhost:3000/chattingroom/${roomId}/chatmember`, {
            method: 'GET',
            headers: {
                'Authorization': accessToken
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentUserId = data.data.member.id;

                // socket.io 연결 설정
                socket = io('http://localhost:3000/chatting', {
                    withCredentials: true,
                    auth: {
                        token: accessToken
                    }
                });

                setupSocketListeners();
                socket.emit('joinRoom', { roomId });
            } else {
                throw new Error(data.message || '채팅 멤버가 아닙니다.');
            }
        })
        .catch(error => {
            console.error('채팅방 입장 실패:', error);
            alert(error.message || '채팅방 입장에 실패했습니다.');
            window.location.href = './chattingroom.html';  // 상대 경로로 수정
        });
      });

      function setupSocketListeners() {
        socket.on('connect', () => {
          console.log('소켓 연결됨:', socket.id);
          addSystemMessage('채팅방에 연결되었습니다.');
        });

        socket.on('message', (data) => {
          console.log('새 메시지 수신:', data);
          addMessage(data);
        });

        socket.on('userJoined', (data) => {
          console.log('사용자 입장:', data);
          addSystemMessage(`${data.nickname}님이 입장하셨습니다.`);
        });

        socket.on('userLeft', (data) => {
          console.log('사용자 퇴장:', data);
          addSystemMessage(`${data.nickname}님이 퇴장하셨습니다.`);
        });

        socket.on('error', (error) => {
          console.error('소켓 에러:', error);
          addSystemMessage('오류가 발생했습니다.');
        });
      }

      // 메시지 전송 함수
      function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (message && socket && currentRoomId) {
          console.log('메시지 전송 시도:', {
            roomId: currentRoomId,
            message: message
          });

          socket.emit('sendMessage', {
            roomId: currentRoomId,
            message: message
          }, (response) => {
            console.log('메시지 전송 응답:', response);
            
            if (response.success) {
              // 메시지 입력창 초기화만 하고, 메시지 표시는 하지 않음
              messageInput.value = '';
            } else {
              console.error('메시지 전송 실패:', response.message);
              alert('메시지 전송에 실패했습니다.');
            }
          });
        }
      }

      // 메시지 표시 함수
      function addMessage(messageData) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        const isMyMessage = messageData.userId === currentUserId;
        
        messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
        
        const timestamp = new Date(messageData.timestamp).toLocaleTimeString();
        
        if (isMyMessage) {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="message-text">${messageData.message}</div>
              <span class="timestamp">${timestamp}</span>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="nickname">${messageData.nickname}</div>
            <div class="message-content">
              <div class="message-text">${messageData.message}</div>
              <span class="timestamp">${timestamp}</span>
            </div>
          `;
        }
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // 채팅방 나가기 함수
      function leaveRoom() {
        if (currentRoomId && socket) {
          socket.emit('leaveRoom', { roomId: currentRoomId }, (response) => {
            if (response.success) {
              window.location.href = 'login.html';
            } else {
              console.error('채팅방 나가기 실패:', response.message);
            }
          });
        }
      }

      // Enter 키로 메시지 전송
      function handleKeyPress(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      // 시스템 메시지 추가
      function addSystemMessage(message) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system';
        messageDiv.innerHTML = `
          <div class="message-content">
            ${message}
          </div>
        `;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // 채팅방 UI 초기화 함수
      function initializeChatRoom(roomId) {
        // 채팅방 제목과 멤버 정보 설정
        const chatTitle = document.querySelector('.chat-title');
        chatTitle.textContent = `채팅방 ${roomId}`;
        
        // 소켓 이벤트 리스너 설정
        setupSocketListeners();
      }

      // 멤버 목록 업데이트 함수
      function updateMemberList(members) {
        const memberList = document.querySelector('.member-list ul');
        if (memberList) {
          memberList.innerHTML = members.map(member => `
            <li>${member.nickname}</li>
          `).join('');
        }
      }
    </script>
  </body>
</html>
